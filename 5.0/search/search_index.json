{"config":{"lang":["en","fr"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"GeoNetwork 5","text":"<p>Welcome to GeoNetwork 5 documentation!  This documentation refers to the version 5, that is currently under development.</p>"},{"location":"#looking-for-other-versions","title":"Looking for other versions?","text":"<ul> <li>GeoNetwork Latest Documentation </li> <li>GeoNetwork Stable Documentation </li> </ul>"},{"location":"#whats-new-in-geonetwork-5","title":"What\u2019s new in GeoNetwork 5","text":"<p>GeoNetwork 5 is the next big step in the project\u2019s evolution. Its highlight is native support for the OGC API Records standard, bringing web-native, standards-based catalog services. Even though it\u2019s still under development, you can already run it alongside GeoNetwork 4.4 and publish your existing catalogs through this new API, combining the stability of today with the possibilities of tomorrow.</p>"},{"location":"#learn-more","title":"Learn more","text":"<ul> <li> <p> Integration with GN4</p> <p>How to use GN5 and GN4 together via the proxy gateway.</p> </li> </ul> <ul> <li> <p> OGCAPI-Records</p> <p>Details of the implementation in GeoNetwork 5.</p> </li> </ul> <ul> <li> <p> Developer docs</p> <p>Guides for contributing and extending GeoNetwork.</p> </li> </ul>"},{"location":"#get-involved","title":"Get Involved","text":"<p>GeoNetwork is an open-source project, and its future depends on the community. There are several ways you can help shape GeoNetwork 5 and beyond:</p> <ul> <li>Contribute code: Join the ongoing development and help build the next generation of metadata catalog services. A great first step is to join our Developers Meeting.</li> <li>Sponsor developments: Support the project financially and help prioritize new features. Check out the 2025 Sponsorship Opportunities.</li> </ul> <p>Every contribution helps keep GeoNetwork strong, open, and innovative for the future.</p>"},{"location":"Developer/","title":"GeoNetwork 5 Developer Documentation","text":"<p>Welcome to the GeoNetwork developer documentation! This guide provides a high-level overview of the project\u2019s architecture, design principles, and technical foundations. Whether you\u2019re contributing code, integrating services, or deploying GeoNetwork in your environment, this documentation will help you get started.</p> <p>Content of this documentation</p> <ul> <li>Formatters: Guide to understand formatters and how to implement them.</li> <li>Security inside GN5: Internal GN5 security</li> <li>Creating a New App: Creating a new app (introduction to the App Architecture)</li> <li>Dynamic Properties in OGCAPI-Records: Creating a new app (introduction to the App Architecture)</li> <li>Link Management in OGCAPI-Records: Creating a new app (introduction to the App Architecture)</li> <li>Facets</li> <li>GN5 Workshop: Creating a new app (introduction to the App Architecture)</li> </ul>"},{"location":"Developer/facets/","title":"Facets in OGCAPI-Records","text":"<p>Facets are defined in the the OGCAPI-Records Part 2 - facets specification.</p> <p>This specification is a work-in-progress and the implementation is based on the written specification as well as question/answers on the OGCAPI-Records GitHub issues.</p> <p>The defined buckets are converted to Elastic Aggregates - with special handling for Date, Number, and String types (cf. Dynamic Typing) and Fixed Width histograms vs Fixed Number-of-Buckets histograms. </p>"},{"location":"Developer/facets/#overview","title":"Overview","text":"<p>The basic Facet process is as follows:</p> <ol> <li> <p>The user configuration contains a set of dynamic properties (<code>OgcElasticFieldMapperConfig</code>).  Each property can defines multiple facets (<code>OgcFacetConfig</code>).</p> </li> <li> <p>As in the OGCAPI-Records Part 2 - facets specification, there are 3 types of histograms (with 2 types of Histogram facets):</p> <ul> <li>TERM - for text (keyword) fields in Elastic (ie. the equivalent of java <code>enum</code>)</li> <li>FILTER - for arbitrary (defined by CQL) filters</li> <li>HISTOGRAM_FIXED_BUCKET_COUNT - histogram with a fixed number of buckets (for numbers and dates)</li> <li>HISTOGRAM_FIXED_INTERVAL - histogram with a fixed width of the buckets (for numbers and dates)</li> </ul> </li> <li> <p>You can also specify other information about the facet:</p> <ul> <li><code>facetName</code> - name of the facet (used to name the response facet property name)</li> <li><code>facetType</code> - as defined above</li> <li><code>bucketSorting</code> - either sort by COUNT (i.e. bucket with most records) or sort by VALUE (i.e. date order, numeric order, or string order)</li> <li><code>bucketCount</code> - how many buckets should there be (overrides the default)</li> <li><code>minimumDocumentCount</code> - buckets with less than this number will be removed.  Typically set to 1 (remove empty buckets).</li> <li><code>numberBucketInterval</code> for Number Histograms, the bucket interval (width)</li> <li><code>calendarIntervalUnit</code> for Date Histograms, the bucket interval (width).  Supports  <code>year</code>, <code>month</code>, <code>week</code>, <code>day</code>, <code>hour</code>, <code>minute</code>, <code>second</code>, and <code>quarter</code> (see Elastic Documentation)</li> <li><code>field</code> for information about the field configuration (from user) - this defines where in the data is in the Elastic Index </li> </ul> </li> <li> <p>An Elastic Aggregation query is added to the main (<code>/items</code>) query that will retrieve all the results.  These are then converted to the OGCAPI-Records (Part 2) defined format.</p> </li> </ol>"},{"location":"Developer/facets/#getting-actual-records-from-a-bucket","title":"Getting Actual Records from a Bucket","text":"<p>Typically, its fairly easy to query for the Records in a bucket with a CQL expression.</p> <p>Please see <code>QueryTest#testBucketCql()</code> for lots of examples.  Also, the Angular OGCAPI-Records application also does this.</p> <p>Watch for final bucket</p> <p>In general, to get the contents of a bucket, make a request like:</p> <p>property &gt;= min_value AND property &lt; max_value</p> <p>However, for the last bucket, your CQL should be (notice the <code>&lt;=</code> instead of <code>&lt;</code>):</p> <p>property &gt;= min_value AND property &lt;= max_value</p> <p>This is marked in the facet responses to easily see which bucket is the last one (<code>x-highest-bucket: true</code>).</p>"},{"location":"Developer/formatters/","title":"GeoNetwork Formatters","text":"<p>The GeoNetwork formatter system provides a flexible architecture for transforming metadata records into various output formats. This guide explains the basic design and how to implement custom formatters.</p>"},{"location":"Developer/formatters/#architecture-components","title":"Architecture Components","text":""},{"location":"Developer/formatters/#1-formatter-interface","title":"1. Formatter Interface","text":"<p>The core <code>Formatter</code> interface defines the contract for all formatters:</p> <pre><code>public interface Formatter {\n    void format(Metadata metadata, String formatterId, OutputStream outputStream, \n                Map&lt;String, Object&gt; config) throws IOException;\n\n    boolean isFormatterAvailable(Metadata metadata, String formatterId);\n}\n</code></pre> <p>Key responsibilities: - Transform metadata into a specific output format - Write the formatted content to an output stream - Check formatter availability for given metadata</p>"},{"location":"Developer/formatters/#2-formatterapi","title":"2. FormatterApi","text":"<p>The <code>FormatterApi</code> class provides high-level operations for formatting:</p> <ul> <li>Access Control: Validates user permissions before formatting</li> <li>Formatter Discovery: Lists available formatters for schemas and metadata</li> <li>Formatter Selection: Finds appropriate formatter based on ID and profile</li> </ul> <p>Key methods: - <code>getRecordFormattedBy()</code>: Main entry point for formatting a metadata record - <code>getAvailableFormattersForSchema()</code>: Lists formatters for a specific schema - <code>getAllFormatters()</code>: Returns all formatters organized by MIME type and profile</p> <p>(Check FormatterApi class for more methods and updated informations)</p>"},{"location":"Developer/formatters/#formatter-types","title":"Formatter Types","text":""},{"location":"Developer/formatters/#1-java-based-formatters-indexformatter-pattern","title":"1. Java-based Formatters (IndexFormatter Pattern)","text":"<p>These formatters work by programmatically transforming data using Java code.</p> <p>Example: IndexFormatter - Retrieves metadata from the search index or from the database - Transforms using Java code or delegates to a processor - Outputs JSON or custom format via processor</p> <p>Advantages: - Full programmatic control - Can integrate with any Java library - Easy unit testing</p> <p>Relevant discussion here</p>"},{"location":"Developer/formatters/#2-xslt-based-formatters-xsltformatter-pattern","title":"2. XSLT-based Formatters (XsltFormatter Pattern)","text":"<p>These formatters use XSLT stylesheets to transform XML metadata, using legacy approach.</p> <p>Example: XsltFormatter - Loads XSLT - Applies transformation to metadata XML - Outputs transformed result</p> <p>Advantages: - Reuse of XML-to-XML transformations developer in metadata101 schemas - Better for XML sources</p> <p>Disvantages: - XSLT availability depends on original schema of XML.</p>"},{"location":"Developer/formatters/#implementing-a-new-formatter","title":"Implementing a New Formatter","text":""},{"location":"Developer/formatters/#option-1-java-based-formatter","title":"Option 1: Java-based Formatter","text":"<ol> <li>Create the formatter class:</li> </ol> <pre><code>@Component\npublic class MyCustomFormatter implements Formatter {\n\n    @Override\n    public void format(Metadata metadata, String formatterId, \n                      OutputStream outputStream, Map&lt;String, Object&gt; config) \n                      throws IOException {\n        try {\n            // 1. Extract data from metadata\n            String metadataXml = metadata.getData();\n\n            // 2. Transform the data\n            String formatted = transformMetadata(metadataXml, config);\n\n            // 3. Write to output stream\n            outputStream.write(formatted.getBytes(StandardCharsets.UTF_8));\n            outputStream.flush();\n\n        } catch (Exception e) {\n            throw new FormatterException(\"Failed to format metadata\", e);\n        }\n    }\n\n    @Override\n    public boolean isFormatterAvailable(Metadata metadata, String formatterId) {\n        // Check if this formatter can handle the metadata\n        return \"myformat\".equals(formatterId);\n    }\n\n    private String transformMetadata(String xml, Map&lt;String, Object&gt; config) {\n        // Your transformation logic here\n        // Can use config for parameters like language, style, etc.\n        return transformedContent;\n    }\n}\n</code></pre> <ol> <li>Register with FormatterFactory:</li> <li>Ensure your formatter is picked up by Spring's component scan</li> <li>Configure in FormatterFactory if needed</li> </ol>"},{"location":"Developer/formatters/#option-2-xslt-based-formatter","title":"Option 2: XSLT-based Formatter","text":"<ol> <li>Create XSLT stylesheet:</li> </ol> <p>Place your XSLT file in the appropriate location:    <pre><code>src/main/resources/schemas/{schema-id}/formatter/{formatter-id}/view.xsl\n</code></pre></p> <p>Example XSLT:    <pre><code>&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n&lt;xsl:stylesheet version=\"2.0\" \n                xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\"&gt;\n\n    &lt;xsl:output method=\"html\" encoding=\"UTF-8\"/&gt;\n\n    &lt;xsl:template match=\"/\"&gt;\n        &lt;html&gt;\n            &lt;body&gt;\n                &lt;h1&gt;&lt;xsl:value-of select=\"//title\"/&gt;&lt;/h1&gt;\n                &lt;!-- Your transformation here --&gt;\n            &lt;/body&gt;\n        &lt;/html&gt;\n    &lt;/xsl:template&gt;\n&lt;/xsl:stylesheet&gt;\n</code></pre></p> <ol> <li>Use XsltFormatter:</li> <li>The existing <code>XsltFormatter</code> will automatically pick up your XSLT</li> <li>No Java code needed!</li> </ol>"},{"location":"Developer/formatters/#option-3-custom-processor-with-indexformatter","title":"Option 3: Custom Processor with IndexFormatter","text":"<p>For complex transformations that need index data:</p> <ol> <li>Create a processor:</li> </ol> <pre><code>@Component\npublic class MyIndexFormatterProcessor implements IndexFormatterProcessor {\n\n    @Override\n    public void process(IndexRecord indexDocument, OutputStream outputStream, \n                       Map&lt;String, Object&gt; config) throws IOException {\n        // Transform index record to your format\n        MyFormat result = convertToMyFormat(indexDocument);\n\n        // Serialize and write\n        objectMapper.writeValue(outputStream, result);\n    }\n}\n</code></pre> <ol> <li>Register in IndexFormatterProcessorFactory: <pre><code>public IndexFormatterProcessor getFormatterProcessor(String formatterId) {\n    if (\"myformat\".equals(formatterId)) {\n        return myIndexFormatterProcessor;\n    }\n    return null;\n}\n</code></pre></li> </ol>"},{"location":"Developer/new-app/","title":"New app","text":""},{"location":"Developer/new-app/#creating-a-new-app","title":"Creating a New App","text":"<p>GN5 has several mechanisms to make it easier to create new Applications.  In general, there are three main use-cases:</p> <ul> <li>Curating existing Modules</li> <li>Changing the configuration of existing Modules</li> <li>Creating your own module</li> </ul>"},{"location":"Developer/new-app/#curating-existing-modules","title":"Curating existing Modules","text":"<p>Typically, this use case is to create an application based on existing modules.  For example, you might want to have an application that has OGCAPI-Records as well as configuring a proxy to GN4.  </p> <p>These are easy to create - just add the needed modules as dependencies!</p> <p>Process:</p> <ol> <li>Checkout GN5 and build</li> <li>Create a new directory in the <code>src/apps</code> folder</li> <li>Create a <code>pom.xml</code> in your directory</li> <li> <p>Inside your <code>pom.xml</code>, fill in the basic outline (see <code>src/apps/workshop/workshop1_app/pom.xml</code> for an example)</p> <ul> <li>Parent's <code>&lt;artifactId&gt;</code> should be <code>gn-apps</code></li> <li>Give your app a unique <code>&lt;artifactId&gt;</code></li> <li>Add a <code>&lt;name&gt;</code> and <code>&lt;description&gt;</code></li> <li>Ensure you have the <code>&lt;build&gt;</code> section so that spring can find the main Application to run</li> <li>In the <code>&lt;dependencies&gt;</code> section, make sure you reference <code>gn-generic-app</code>:</li> </ul> <pre><code>    &lt;dependency&gt;\n        &lt;groupId&gt;org.geonetwork&lt;/groupId&gt;\n        &lt;artifactId&gt;gn-generic-app&lt;/artifactId&gt;\n        &lt;version&gt;${project.version}&lt;/version&gt;\n    &lt;/dependency&gt;\n</code></pre> <ul> <li>Reference the other applications or modules you require in the  <code>&lt;dependencies&gt;</code> section:</li> </ul> <pre><code>    &lt;!-- this will add the OGCAPI-Records to your application--&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.geonetwork&lt;/groupId&gt;\n        &lt;artifactId&gt;gn-ogcapi-records-implementation&lt;/artifactId&gt;\n        &lt;version&gt;${project.version}&lt;/version&gt;\n    &lt;/dependency&gt;\n\n    &lt;!-- this will add the GN4-proxy module to your application--&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.geonetwork&lt;/groupId&gt;\n        &lt;artifactId&gt;gn-4&lt;/artifactId&gt;\n        &lt;version&gt;${project.version}&lt;/version&gt;\n    &lt;/dependency&gt;\n</code></pre> <ul> <li>Run your application</li> </ul> <pre><code>    mvn spring-boot:run\n</code></pre> <ul> <li>Your application will be available at  http://localhost:7979/geonetwork</li> <li>OGCAPI-Records will be available at http://localhost:7979/geonetwork/ogcapi-records</li> <li>The proxied GN4 will be available at  http://localhost:7979/geonetwork/srv NOTE: ensure you have a running GN4 at http://localhost:8080/geotwork and configure it accept security headers from GN5.</li> </ul> </li> </ol>"},{"location":"Developer/new-app/#changing-the-configuration-of-existing-modules","title":"Changing the configuration of existing Modules","text":"<p>In many cases you will want to change the configure of GN5 and its modules.  This is done by modifying the \"<code>application.yml</code>\" files.</p> <p>Better way to do this in the future</p> <p>This method involves hard-coding changes to the \"<code>application.yml</code>\" files in the repository. We are working on a simpler way to do this.  See Multiple Application.yml, below.</p> <p>Process:</p> <ol> <li>Create your curated application</li> <li> <p>Find the applicable \"<code>application.yml</code>\" files and modify them</p> <ul> <li>The main \"<code>application.yml</code>\" is in <code>config/application.yml</code></li> <li>The OGCAPI-Records configuration is in <code>config/application-ogcapi-records.yml</code></li> <li>The GN4 Proxy configuration is in <code>src/modules/geonetwork4/src/main/resources/application-proxy.yml</code></li> </ul> </li> <li> <p>Rebuild GN5</p> </li> <li>Run your application</li> </ol> <p>Finding the \"<code>application.yml</code>\" files</p> <p>See below for some help finding the  \"<code>application.yml</code>\" files for a module/application.</p>"},{"location":"Developer/new-app/#creating-your-own-module","title":"Creating your own Module","text":"<p>You can build your own modules.  In general, the directory structure is:</p> <ul> <li><code>src/apps</code> - these are spring-boot applications and can be run</li> <li><code>src/modules</code> - these define controllers for the spring-boot applications.  Typically these are very simple.</li> <li><code>src/shared</code> - these are \"groups\" of functionality that can be shared with other modules.</li> </ul>"},{"location":"Developer/new-app/#very-simple-modules","title":"Very Simple Modules","text":"<p>These are module that are very simple with very little code.  They just defines a <code>src/app</code> application and do not need a <code>src/shared</code> module.  An example is the workshop1_app.</p> <p>This is a trivial module that just does a few calculations on what is in the GN <code>metadata</code> database table.</p> <p>Lets look at this in a little more detail.  This only contains a <code>pom.xml</code> and a single java file (<code>WorkshopController.java</code>)</p>"},{"location":"Developer/new-app/#pomxml","title":"<code>pom.xml</code>","text":"<p>See Curating existing Modules, above, for more details.</p> <p>This has a dependency on:</p> <ul> <li><code>gn-generic-app</code> (which provides the GN5 spring-boot infrastructure)</li> <li><code>gn-schemas</code> which pulls in the basic DB and schema support (this is a <code>src/shared</code> module)</li> </ul> <p>It also has the <code>&lt;build&gt;&lt;plugin&gt;</code> so spring-boot can find the main Application class.</p>"},{"location":"Developer/new-app/#workshopcontrollerjava","title":"<code>WorkshopController.java</code>","text":"<p>This defines the following endpoints:</p> <ul> <li>http://localhost:7979/geonetwork/workshop1</li> <li>http://localhost:7979/geonetwork/workshop1b</li> <li>http://localhost:7979/geonetwork/workshop1c</li> <li>http://localhost:7979/geonetwork/workshop1d</li> <li>http://localhost:7979/geonetwork/workshop1e</li> </ul> <p>OpenAPI (swagger) endpoints (for use with the <code>workshop1e</code> endpoint):</p> <ul> <li>http://localhost:7979/geonetwork/v3/api-docs?f=json JSON version of the OpenAPI document</li> <li>http://localhost:7979/geonetwork/swagger-ui/index.html HTML version of teh OpenAPI document</li> </ul> <p>These endpoints:</p> <ul> <li>workshop1 - returns hardcoded trivial hello-world <code>String</code></li> <li>workshop1b - returns hardcoded <code>Map&lt;String,Long&gt;</code> </li> <li>workshop1c - returns hardcoded <code>GeoNetworkMetadataSummary</code></li> <li>workshop1d - returns with real DB results </li> <li>workshop1e - same as workshop1d, but with openapi information</li> </ul> <p>The endpoints go from very simple more complex (including communicating with the DB).</p>"},{"location":"Developer/new-app/#more-complex-modules","title":"More Complex Modules","text":"<p>An example is the workshop2_app does the same thing as workshop1's <code>workshop1e</code>.  However, we do this in a way that is more organized (and follows the way the OGCAPI-Records module is constructed).</p> <p>The main differences between <code>workshop1_app</code> and <code>workshop2_app</code> are:</p> <ol> <li>Instead of hand-coding our controllers and the controllers response object, we autogenerate them from OpenAPI (swagger) <code>.yml</code> files</li> <li>We use the full <code>src/app</code>, <code>src/module</code>, and <code>src/shared</code> source layout</li> <li>We use more spring-oriented Repository access (DB)</li> </ol>"},{"location":"Developer/new-app/#source-code-layout-srcapp-srcmodule-and-srcshared","title":"Source code layout (<code>src/app</code>, <code>src/module</code>, and <code>src/shared</code>)","text":"Location Content <code>src/app</code> This is the application - typically, it only contains a <code>pom.xml</code> to manage \"pulling in\" dependencies <code>src/module</code> This is where the spring controllers are defined.  In this example it contains two modules - one that auto-generates controller interface and response objects from OpenAPI <code>.yml</code> documents.  It also contains a trivial implementation of the controller API that \"hands off\" the work to a class in <code>src/shared</code> <code>src/shared</code> This is where the actual code goes.  In this case, it accesses the database and creates the actual response object.  It can use other GN5 code by depending on other <code>/src/shared</code> modules."},{"location":"Developer/new-app/#generating-openapi-swagger-yml-files","title":"Generating OpenAPI (swagger) <code>.yml</code> files","text":"<p>In <code>workshop1_app</code>, we defined (by hand):</p> <ul> <li>Controllers methods (including some OpenAPI metadata in <code>workshop_1e</code>) in <code>WorkshopController</code></li> <li>A controller response object (<code>GeoNetworkMetadataSummary</code>) </li> </ul> <p>In <code>workshop2_app</code>, we do this differently:</p> <ul> <li>We create a OpenAPI <code>.yml</code> document that defines our controller methods and describes the response objects)</li> <li>We use this to auto-generate spring controller Java interface and the Java controller response object (see <code>Workshop2Api</code> and <code>Workshop2MetadataSummarySchemaDto</code>) </li> <li>We create a (hand-made) trivial implementation of the controller interface (see <code>Workshop2ControllerImpl</code>).  This just hands the work off to methods in <code>shared</code></li> </ul> <p>This is all done in the <code>module</code> directory.</p>"},{"location":"Developer/new-app/#actual-implementation-srcshared","title":"Actual Implementation (<code>/src/shared</code>)","text":"<p>This is where the actual work is being done - we query the database and fill in the <code>Workshop2MetadataSummarySchemaDto</code> object.  In general, the code in the <code>src/module</code> should be very simple - just a few lines for each endpoint.  They should hand off to a class in a <code>src/shared</code> class which is more in-depth.  This helps to make sure that the <code>src/shared</code> code is stand-alone and re-usable by other modules.</p>"},{"location":"Developer/new-app/#spring-oriented-repository","title":"Spring-oriented Repository","text":"<p><code>workshop2_app</code> also gives an example of more complex database interactions (cf. <code>SummarizingMetadataRepository</code>).  This is standard JPA, but worth pointing out.</p>"},{"location":"Developer/new-app/#support-for-building-your-own-modules","title":"Support for Building your own Modules","text":"<p>The architecture of GN5 allows for building new and combing existing modules.  </p> Location Content <code>src/app</code> This is the spring-boot app.  Typically, it only contains a <code>pom.xml</code> to manage \"pulling in\" existing dependencies (modules) <code>src/module</code> This is where the spring controllers are defined.  This should NOT be complex - the controller endpoints should be trivial (only a few lines). <code>src/shared</code> This is where the actual code goes.  This should be fairly independent so it can be re-used elsewhere."},{"location":"Developer/new-app/#curating-modules","title":"\"Curating\" modules","text":"<p>See Curating existing Modules, above.  GN5 makes it easy to put together multiple spring-boot applications just inside the <code>pom.xml</code>.</p>"},{"location":"Developer/new-app/#auto-generate-via-openapi","title":"\"Auto Generate\" via OpenAPI","text":"<p>See section on OpenAPI generation, above.  Although this is not necessary (see <code>workshop1_app</code>, above), it helps to make endpoint definitions more clear (and with documentation).  OGCAPI-Records was created this way - we took the OGCAPI OpenAPI definition and tweaked it a bit to produce good DTOs.</p>"},{"location":"Developer/new-app/#multiple-applicationyml","title":"Multiple <code>application.yml</code>","text":"<p>One of new things that GN5 introduces is the ability to have multiple <code>application.yml</code> file (see above).</p> <p>Please see <code>IConfigurationLocator</code> and its implementations (especially <code>AbstractResourceApplicationYmlProvider</code>).</p> <p>These <code>IConfigurationLocator</code> classes are picked up VERY early in the spring-boot start-up process.  They can then add an ordered <code>application.yml</code> file that can either add new configuration items or override the value of previous one.  They are ordered by priority (lower value mean loaded first) and then we use the <code>spring.config.location</code> mechanism to load them.</p> <p>This is really useful.  For example, in our example (OGCAPI-Records and the GN5-to-GN4 proxy) we have several <code>application.yml</code> loaded:</p> <ol> <li><code>config/application.yml</code> - this is the basic configuration of the GN5 spring-boot app with deals of PostgreSQL and Elastic connection details, etc...</li> <li><code>config/application-ogcapi-records.yml</code> - this configures the OGCAPI-Records module, especially dynamic properties and default profiles (see Content Negotiation System)</li> <li><code>src/modules/geonetwork4/src/main/resources/application-proxy.yml</code> - defines the configuration of the spring gateway proxy to GN4.</li> </ol> <p>If you make a new module that needs configuration, simple add an <code>application-*.yml</code> to your <code>src/java/main/resources</code> directory and include an <code>AbstractResourceApplicationYmlProvider</code> subclass (pointing to your <code>application-*.yml</code> with a given priority). This can override existing items (larger priority number \"wins\") or add new ones.</p> <p><code>IConfigurationLocator</code> implementations must be in the <code>org.geonetwork.application</code> package</p> <p>In order to quickly scan for the <code>IConfigurationLocator</code> implementations, we only scan for them in the <code>org.geonetwork.application</code> package.  Implementation in other packages will not be detected.</p>"},{"location":"Developer/new-app/#test-containers-integration-testing","title":"Test Containers (Integration Testing)","text":"<p>There is support for running sprint-boot integration tests - with a real PostgreSQL and Elastic running.  </p> <p>The two main examples are:</p> <ul> <li><code>QueryTest</code> and <code>DynamicPropertiesTest</code> - this starts PostgreSQL and Elastic pre-loaded with sample data (from the GN-UI project).</li> <li><code>EmptyIndexTest</code> - this starts Elastic without pre-loaded sample data.</li> </ul> <p>These are very good creating specific integration tests - including how the elastic queries actually interact with the database.</p> <p>Test Containers and spring-boot configuration</p> <p>You may find the Test Container setup complicated.  This is mostly because of the integration between Test Containers and the spring-boot <code>ApplicationContextInitializer</code> interact with very expensive startup (i.e. it takes 20 seconds to startup the Elastic container). There is \"fighting\" with some things wanting to be <code>static</code> (which is difficult with subclass).  See <code>QueryTest</code>, <code>DynamicPropertiesTest</code>, and <code>EmptyIndexTest</code>.  Spring-boot will often create two copies of a class (one for the test case and one for the <code>ApplicationContextInitializer</code>).  The way it is currently setup avoids this (but makes the test cases a little bit more complicated).</p>"},{"location":"Developer/new-app/#content-negotiation-system","title":"Content Negotiation System","text":"<p>OGCAPI-Records content negotiation is quite complicated.  In a typical spring-boot system, you would have controllers returns a java POJO that will then be typically transcribed as JSON or XML.  However, OGCAPI-Records is more complex as it introduces the concept of \"profiles\".</p> <p>For example, we support <code>application/rdf+xml</code> (i.e. DCAT) with a profiles of <code>eu-dcat-ap-hvd</code>, <code>eu-geodcat-ap</code>, <code>dcat</code>, <code>eu-dcat-ap</code> (more being added).  These are dynamic (i.e. change as the XSLT schemas are updated).  However, the JSON/XML and RDF+XML representations aren't just re-encodings of the same object - they are quite different.  Also, each profile is quite different.  This doesn't quite match the simple spring-boot content management system.</p> <p>In spring-boot, the basic process is that the controller endpoint returns a POJO.  Spring-boot looks at the request to see what format has been requested (i.e. with \"Accepts:\" header or \"?f=json\" in the query). It will then look up a <code>HttpMessageConverter</code> that knows how to convert that POJO to the requested format.</p> <p>In the OGCAPI-Records module, its a bit more complicated.</p> <ol> <li>As normal, the request comes to the controller endpoint.</li> <li> <p>However, we do not return the \"big\" POJO of the response.  Instead we encapsulate the request parameter (and perhaps a small amount of actual data) in a simple <code>IControllerResponse</code> object.</p> </li> <li> <p><code>OgcApiLandingPageResponse</code> - for the OGCAPI-Records landing page (<code>/</code>)</p> </li> <li><code>OgcApiRecordsCollectionsResponse</code> - for the OGCAPI-Records collections page  (<code>/collections</code>)</li> <li><code>OgcApiCollectionResponse</code> - for the OGCAPI-Records single-collection page (<code>/collections/&lt;collectionId&gt;</code>)</li> <li><code>OgcApiRecordsMultiRecordResponse</code> - for the OGCAPI-Records collection-items page  (<code>/collections/&lt;collectionId&gt;/items</code>)</li> <li> <p><code>OgcApiRecordsSingleRecordResponse</code> - for the OGCAPI-Records collection-items-record page (<code>/collections/&lt;collectionId&gt;/items/&lt;recordId&gt;</code>)</p> </li> <li> <p>These will typically have a <code>RequestMediaTypeAndProfile</code> which resolves the requests MIME TYpe as well as does content negotiation (including a default profile if one isn't specified)</p> </li> <li>These are then sent to \"special\" (<code>HttpMessageConverter</code>) that is profile-aware</li> <li>These <code>HttpMessageConverter</code>s will actually do the \"hard\" work of creating the output content (i.e. in Java or in XSLT).</li> </ol> <p>There are two main type of <code>HttpMessageConverter</code>:</p> <ul> <li><code>IContentNegotiationInitializable</code> - This is a factory class for dynamic converters that return <code>IControllerResultFormatter</code>s.  These are used for runtime-based converters like the <code>FormatterApi</code> produces (ie. GN XSLT and <code>IndexRecord</code> based converters managed by the <code>SchemaManager</code>). These create a profile-aware class that </li> <li>Regular <code>HttpMessageConverter</code> - These should have a <code>#write(...)</code> method that handles a specific <code>IControllerResponse</code> so it can be found with reflection.  These should handle one MimeType and and one <code>IControllerResponse</code> type.  See <code>CswCollectionMessageWriter</code> and <code>OgcApiCollectionResponseFormatter</code> for examples.</li> </ul> <p>Basically, on startup, <code>WebConfig</code> will call <code>MessageWriterUtil</code> that looks for the <code>IContentNegotiationInitializable</code> to create the runtime (i.e. <code>FormatterApi</code>) message converters.  It also keeps track all the <code>HttpMessageConverter</code>s in the system.  <code>MimeAndProfilesForResponseType</code> is the key class for querying the content negotiation system.  </p> <p>Profile negotiation is done by <code>RequestMediaTypeAndProfileBuilder</code> and creates a <code>RequestMediaTypeAndProfile</code> for each request.  These are typically placed in the <code>IControllerResults</code> object.  This helps simplify later logic since the negotiated MIME type and profile (including default profiles) are determined.</p> <p>Please look into these classes:</p> <ul> <li><code>IControllerResults</code> - interface to mark POJO objects as special objects that can be formatted.</li> <li><code>MessageWriterUtil</code> - setups (<code>IContentNegotiationInitializable</code>) and contains a list of all the <code>HttpMessageConverter</code>s in the system.</li> <li><code>MimeAndProfilesForResponseType</code> - given a <code>IControllerResults</code>, gives information about how it can be formatted.  This is a core class.</li> <li><code>RequestMediaTypeAndProfile</code> and <code>RequestMediaTypeAndProfileBuilder</code> - this does the profile negotiation (typically attached to the <code>IControllerResults</code>).</li> </ul> <p>Helpful hints:</p> <ul> <li>the order of the <code>MessageConverter</code>s are important - the first one to match \"wins.\"  We put the more specific ones first in the list (i.e. the generic JSON writer is not preferred).</li> <li>One of the key concepts are the <code>ResponseTypeInfo</code>s that are determined by <code>MimeAndProfilesForResponseType</code> for a specific <code>IControllerResponse</code>.  This contains all the info about how that <code>IControllerResponse</code> can be formatted (including all the profiles).  This is used to customize the OpenAPI document as well as the Link system.</li> </ul>"},{"location":"Developer/new-app/#openapi-customizations","title":"OpenAPI Customizations","text":"<p>We handle customizing the OpenAPI (swagger) document in the \"standard\" OpenAPI way (spring's <code>OpenApiCustomizer</code>).</p> <p>Please see:</p> <ul> <li><code>OgcApiRecordOpenApiConfigProperties</code> - add the dynamic properties (for metadata records) to the OpenAPI return object definition </li> <li><code>OgcApiRecordsOpenApiConfigMimeTypes</code> - add the MIME types available as responses to the controller endpoints (based on what <code>MessageConverter</code>s are available)</li> </ul>"},{"location":"Developer/new-app/#other-helpful-info","title":"Other Helpful info","text":"<ol> <li>Dynamic Properties in OGCAPI-Records - Creating a new app (introduction to the App Architecture)</li> <li>Link Management in OGCAPI-Records - Creating a new app (introduction to the App Architecture)</li> <li>GN5 Workshops </li> </ol>"},{"location":"Developer/ogcapi-record-link-management/","title":"OGCAPI-Records Link Management","text":"<p>For OGCAPI-Records, links between objects are created.  </p> <p>The link management interacts strongly with the Content Negotiation System.  One of the \"hard\" things is many return objects have sub-objects (i.e. <code>/items</code> and <code>/collections</code> endpoints).  These need to be annotated with \"<code>alternative</code>\" and \"<code>self</code>\" correctly, which can be very difficult.</p>"},{"location":"Developer/ogcapi-record-link-management/#basic-functionality","title":"Basic Functionality","text":"<p>Most of the code for links are in the <code>org.geonetwork.ogcapi.service.links</code> package (<code>src/shared/ogcapi-records</code>).</p> <p>One of the most powerful methods is in <code>BasicLinks</code>:</p> <pre><code>  public void addLinks(\n            RequestMediaTypeAndProfile requestMediaTypeAndProfile,\n            Object page,\n            String endpointFragment,\n            Class&lt;?&gt; linkType)\n</code></pre> Parameter Meaning requestMediaTypeAndProfile This is the actual user request - and contains the requested MIME Type and the negotiated profile. See The Content Negotiation system page This is an object that has a <code>links</code> property (there isn't a parent class due to the autogeneration).  This will be one of the OGCAPI-Records defined \"JSON\" objects. endpointFragment Basically, this is the partial URL for the link (i.e. <code>collections</code> would make a <code>http://localhost:7979/geonetwork/ogcapi-records/collections</code> link) linkType This is the <code>IControllerResult</code> object for the links. See The Content Negotiation System <p>Basically, what this method does is:</p> <ol> <li>Finds all the <code>HttpMessageConverters</code> for the given <code>linkType</code>.  See  The Content Negotiation System</li> <li> <p>It will create a link for each of these <code>HttpMessageConverters</code></p> <ul> <li>If the request (<code>requestMediaTypeAndProfile</code>) and the <code>HttpMessageConverters</code> are the same response object type, then it is marked as either <code>self</code> or <code>alternative</code> based on their MIMEType and negotiated profile.</li> <li>Otherwise, a link title is generated based on the response object type (<code>IControllerResult</code> subclass).</li> </ul> </li> <li> <p>The generated links are then attached to the page (via reflection because there isn't a parent class)</p> </li> </ol>"},{"location":"Developer/ogcapi-record-link-management/#example-1","title":"Example 1","text":"<p>Lets take a quick look what happens in a fairly complex page - the <code>http://localhost:7979/geonetwork/ogcapi-records/collections/&lt;CollectionID&gt;/items?f=json</code> endpoint.</p> <p>In <code>ItemsPageLinks</code>, we will see this snippet of code with adding 5 sets of links:</p> <pre><code>    addLinks(requestMediaTypeAndProfile, page, \"\",  OgcApiLandingPageResponse.class);\n    addLinks(requestMediaTypeAndProfile, page, \"collections/\" + collectionId + \"/items\", OgcApiRecordsMultiRecordResponse.class);\n    addLinks(requestMediaTypeAndProfile, page, \"collections/\" + collectionId, OgcApiCollectionResponse.class);\n    addLinks(requestMediaTypeAndProfile, page, \"collections\", OgcApiRecordsCollectionsResponse.class);\n\n    addNextPrevious(requestMediaTypeAndProfile, collectionId, page, query);\n</code></pre> <ol> <li>The first adds links to the Landing Page (<code>OgcApiLandingPageResponse</code>)</li> <li>The second adds self/alternative links to the <code>items</code> endpoint (<code>OgcApiRecordsMultiRecordResponse</code>)</li> <li>The third adds links to the particular collection description endpoint (<code>OgcApiCollectionResponse</code>)</li> <li>The fourth adds links to the all-collections endpoint(<code>OgcApiRecordsCollectionsResponse</code>)</li> <li>The fifth adds next/previous links for the <code>items</code> endpoint - this is hardcoded.</li> </ol> <p>Lets looks at the second set of links (self/alternative links to the <code>items</code> endpoint) for this request:</p> <ol> <li> <p>This is a call to the <code>BaseLinks#addLinks()</code> method</p> <ul> <li>the <code>requestMediaTypeAndProfile</code> will be for MIME Type <code>application/json</code>, response object <code>OgcApiRecordsMultiRecordResponse</code>, and no profile (there aren't any profile for the ogcapi-records json output).</li> <li>the page will be the OGCAPI-Records defined (in the OpenAPI document autogenerated java code) <code>OgcApiRecordsGetRecords200ResponseDto</code></li> <li>the endpoint fragment will be <code>collections/3bef299d-cf82-4033-871b-875f6936b2e2/items</code></li> <li>the <code>linkType</code> will be for other <code>/items</code> formats (<code>OgcApiRecordsMultiRecordResponse</code>)</li> </ul> </li> <li> <p><code>BaseLinks#addLinks()</code> will ask the Content Management system for all the <code>HttpMessageConverter</code> for <code>OgcApiRecordsMultiRecordResponse</code>\"</p> <ul> <li><code>application/json</code> (OGCAPI-Records defined JSON output)</li> <li><code>application/geo+json</code> (OGCAPI-Records defined JSON output - which is actually Geo-JSON)</li> <li><code>application/xml</code> (This is actually the <code>CswCollectionMessageWriter</code> that produces CSW-like output)</li> </ul> </li> <li> <p>Each of these links are processed:</p> <ul> <li>the <code>application/json</code> <code>HttpMessageConverter</code> will match the request (<code>requestMediaTypeAndProfile</code>) and will be marked with <code>self</code></li> <li>the other <code>HttpMessageConverter</code>s will not match the request and be marked with <code>alternative</code></li> </ul> </li> </ol> <p>The resulting links are:</p> <pre><code>[\n {\n      \"rel\": \"self\",\n      \"type\": \"application/json\",\n      \"hreflang\": \"eng\",\n      \"href\": \"http://localhost:7979/geonetwork/ogcapi-records/collections/3bef299d-cf82-4033-871b-875f6936b2e2/items?f=application/json\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/geo+json\",\n      \"hreflang\": \"eng\",\n      \"href\": \"http://localhost:7979/geonetwork/ogcapi-records/collections/3bef299d-cf82-4033-871b-875f6936b2e2/items?f=application/geo+json\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/xml\",\n      \"hreflang\": \"eng\",\n      \"href\": \"http://localhost:7979/geonetwork/ogcapi-records/collections/3bef299d-cf82-4033-871b-875f6936b2e2/items?f=application/xml\"\n    }\n]\n</code></pre>"},{"location":"Developer/ogcapi-record-link-management/#example-2","title":"Example 2","text":"<p>Lets take a quick look what happens in another fairly complex page - the <code>http://localhost:7979/geonetwork/ogcapi-records/collections/&lt;CollectionID&gt;/items/&lt;RecordID&gt;?f=application/geo+json</code> endpoint. This page will include all the <code>FormatterApi</code> results.  </p> <p>The main code is in <code>ItemPageLinks#addAllLinks()</code>:</p> <pre><code> addLinks(\n    requestMediaTypeAndProfile,\n    page,\n    \"collections/\" + collectionId + \"/items/\" + page.getId(),\n    OgcApiRecordsSingleRecordResponse.class);\n</code></pre> <p>See above for what these means.  </p> <p>The <code>requestMediaTypeAndProfile</code> object will be resolved as:</p> <p></p> <p>The Content Negotiation System will find four <code>HttpMessageConverter</code>s:</p> <ul> <li>An <code>application/json</code> provider that creates the OGCAPI-Records defined JSON output for profiles <code>http://www.opengis.net/def/profile/OGC/0/ogc-record</code> and <code>http://geonetwork.net/def/profile/elastic-json-index</code>.</li> <li>An <code>application/geo+json</code> is exactly the same as the <code>application/json</code>, but only for profile (<code>http://www.opengis.net/def/profile/OGC/0/ogc-record</code>)</li> <li>An <code>application/xml</code> for profiles <code>http://geonetwork.net/def/profile/raw-xml</code> and <code>http://geonetwork.net/def/profile/datacite</code></li> <li>An <code>application/rdf+xml</code> for profiles <code>http://geonetwork.net/def/profile/eu-dcat-ap-hvd</code>, <code>http://geonetwork.net/def/profile/eu-geodcat-ap</code>, <code>http://geonetwork.net/def/profile/dcat</code>, and <code>http://geonetwork.net/def/profile/eu-dcat-ap</code></li> </ul> <p>The request will match the first formatter with profile <code>http://www.opengis.net/def/profile/OGC/0/ogc-record</code> - this link will be marked with <code>self</code>, while the others will be marked with <code>alternative</code>.</p> <p>The generated links will be:</p> <pre><code>[\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/geo+json\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://www.opengis.net/def/profile/OGC/0/ogc-record\"\n      ],\n      \"href\": \"http://localhost:7979/geonetwork/ogcapi-records/collections/3bef299d-cf82-4033-871b-875f6936b2e2/items/004571b9-4649-42b3-9c28-a8cdc2bf53c7?f=application/geo+json\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/rdf+xml\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/eu-dcat-ap-hvd\",\n        \"http://geonetwork.net/def/profile/eu-geodcat-ap\",\n        \"http://geonetwork.net/def/profile/dcat\",\n        \"http://geonetwork.net/def/profile/eu-dcat-ap\"\n      ],\n      \"href\": \"http://localhost:7979/geonetwork/ogcapi-records/collections/3bef299d-cf82-4033-871b-875f6936b2e2/items/004571b9-4649-42b3-9c28-a8cdc2bf53c7?f=application/rdf+xml\"\n    },\n    {\n      \"rel\": \"self\",\n      \"type\": \"application/json\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://www.opengis.net/def/profile/OGC/0/ogc-record\",\n        \"http://geonetwork.net/def/profile/elastic-json-index\"\n      ],\n      \"href\": \"http://localhost:7979/geonetwork/ogcapi-records/collections/3bef299d-cf82-4033-871b-875f6936b2e2/items/004571b9-4649-42b3-9c28-a8cdc2bf53c7?f=application/json\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/xml\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/raw-xml\",\n        \"http://geonetwork.net/def/profile/datacite\"\n      ],\n      \"href\": \"http://localhost:7979/geonetwork/ogcapi-records/collections/3bef299d-cf82-4033-871b-875f6936b2e2/items/004571b9-4649-42b3-9c28-a8cdc2bf53c7?f=application/xml\"\n    }\n]\n</code></pre> <p>Notice that the <code>application/json</code> is marked as <code>self</code>.  Also, note that the response headers will include:</p> <p><code>Link: &lt;http://www.opengis.net/def/profile/OGC/0/ogc-record&gt;; rel=\"profile\"</code></p>"},{"location":"Developer/ogcapi-record-link-management/#see-other","title":"See Other","text":"<ul> <li>OGCAPI-Records specification</li> <li>Creating a new Application</li> <li>OGCAPI-Records Dynamic Properties</li> <li>Workshops</li> <li>The Content Negotiation System</li> <li>Formatters</li> </ul>"},{"location":"Developer/ogcapi-records-dynamic-properties/","title":"OGCAPI-Records Dynamic Properties","text":"<p>Dynamic Properties are user-defined (cf. <code>application-ogcapi-records.yml</code>) set of \"extra\" properties (from the Elastic <code>IndexRecord</code>) that are added to the metadata records JSON <code>properties</code>.  This is a very powerful system for customizations.  </p> <p>See <code>OgcElasticFieldMapperConfig</code> (cf. <code>application-ogcapi-records.yml</code>) for how the user can configure the Dynamic Properties:</p> <ol> <li><code>ogcProperty</code> - what the new property should be called in the OGCAPI-Records metadata record's <code>property</code></li> <li><code>elasticProperty</code> - where in the Elastic Index do we get the information from</li> <li><code>indexRecordProperty</code> - where in the parsed <code>IndexRecord</code> is the Elastic information stored?</li> <li><code>isSortable</code> - can you use this property for sorting (<code>sortby</code>)?</li> <li><code>isQueryable</code> - can you use ths property in \"Queryable\" queries?</li> <li><code>addPropertyToOutput</code> - add the property to the OGCAPI-Records metadata record's <code>property</code>?</li> <li><code>typeOverride</code> - allows the user to override a type calculated from the Elastic Index metadata (useful for converting between single-value and list-value objects).</li> <li><code>sortFieldSuffix</code> - Some elastic index properties are not sortable (i.e. text fields), but there might be a sub-object that is sortable (i.e. <code>.keyword</code>) (optional) (see Elastic <code>resourceTitleObject</code>)</li> <li><code>facetsConfig</code> - configuration for multiple facets that this might produce</li> </ol> <p>As you can see, adding a dynamic property has a big impact:</p> <ol> <li>it will typically change the OpenAPI document as well as the actual metadata record JSON returned to the user</li> <li>it will typically change <code>/collections/collectionID/queryables</code> endpoint as well as the <code>.../items</code> query functionality</li> <li>it will typically change <code>/collections/collectionID/sortables</code> endpoint as well as the <code>.../items</code> <code>sortby</code> functionality</li> <li>it will typically change the <code>facets</code> endpoint, as well as add facets to the <code>.../items</code> endpoint</li> </ol> <p>So, this has a big impact on the system.</p>"},{"location":"Developer/tech-security/","title":"Tech security","text":""},{"location":"Developer/tech-security/#security-inside-gn5","title":"Security inside GN5","text":"<p>NOTE: this is about the internal GN5 security.  See the GN4-Integration for detail on the GN5-&gt;GN4 proxy security.</p>"},{"location":"Developer/tech-security/#overview","title":"Overview","text":"<ol> <li>Use <code>AuthenticationFacade</code> for most of your authentication needs</li> <li> <p><code>AuthenticationFacade#geonetworkPermissions()</code> has most of the permissions you will need.  It is built when a user logs in.  It contains;</p> <p>a. Username</p> <p>b. UserId (as per GN database)</p> <p>c. HighestProfile (ie. GN database's Profile)</p> <p>d. Map that goes from Profile -&gt; List of group ids the user has that profile for</p> <p>e. Map that goes from Group id -&gt; List of profiles that the user has for that profile</p> <p>NOTE: for anonymous user, they do not have a username/userid or permissions.  They only have <code>Profile.Guest</code> as their highest profile.</p> </li> <li> <p>You shouldn't be accessing <code>Usergroups</code> or the <code>UsergroupRepository</code> - use the  <code>AuthenticationFacade</code> permissions.</p> </li> <li>You shouldn't be doing anything with <code>\"ROLE_*\"</code> type roles - use the  <code>AuthenticationFacade</code> permissions.</li> </ol>"},{"location":"Developer/workshop/","title":"GN5 Workshops","text":"<p>There are two workshops - workshop1 and workshop2.  Both of the workshops are quite simple.</p> Workshop Purpose <code>workshop1</code> This is a very simple (hard-coded) <code>WorkshopController</code> that produces some information about the metadata schemas and number of records associated with each schema.  Most developers should be able to easily understand this.  It builds up complexity from the <code>workshop1</code> to <code>workshop1e</code> endpoints. <code>workshop2</code> This accomplishes the same things as <code>workshop1</code>, however, it does this is more complicated architecture.  It autogenerates controller definitions and controller response objects from a OpenAPI document.  It lays out code in three modules - <code>app</code>, <code>module</code>, and <code>shared</code>.  This is how most of the larger GN5 modules (like OGCAPI-Records) are created."},{"location":"Developer/workshop/#pre-setup-for-workshops","title":"Pre Setup for Workshops","text":"<p>In order to run the workshops, you will need a running PostgreSQL and Elastic Search database filled with some data.  There are two ways to do this:</p> <ol> <li>Using PostgreSQL and Elastic Search Containers Pre-Filled with Data</li> <li>Using GN4 to Populate Metadata Records</li> </ol>"},{"location":"Developer/workshop/#using-pre-populated-postgresql-and-elastic-search-containers","title":"Using Pre-Populated PostgreSQL and Elastic Search Containers","text":"<p>To run a pre-populated PostgreSQL and Elastic Search databases: <pre><code>cd docker\ndocker-compose -f docker-compose-dbs.yml up -d\n# wait for containers to fully startup\n</code></pre></p> <p>This will contain about 40 sample metadata records - taken from the GN-UI project.</p>"},{"location":"Developer/workshop/#use-gn4-to-populate-empty-postgresql-and-elastic-search-containers","title":"Use GN4 to Populate Empty PostgreSQL and Elastic Search Containers","text":"<p>This open will create an empty PostgreSQL and Elastic Search databases.  You can then use GN4 to populate metadata.</p> <p>To run empty PostgreSQL and Elastic Search databases: <pre><code>cd docker\ndocker-compose -f docker-compose-dbs-empty.yml up -d\n# wait for containers to fully startup\n</code></pre></p> <p>To run GN4 connected to those database:</p> <pre><code>docker-compose -f docker-compose-gn4.yml up -d\n# wait for GN4 to startup\n</code></pre> <p>After the GN4 container has started, go to http://localhost:8080/geonetwork.  From there, you can do one of these:</p> <ul> <li>Login to GN4 as admin, import the <code>sample-gn-data-for-import.zip</code> data (30 records from the <code>GN-UI</code> project)</li> <li>Login to GN4 as admin, import the ISO19139 sample data</li> <li>Login to GN4 as admin, harvest from another server</li> <li>Login as a user, create your own sample data</li> </ul>"},{"location":"Developer/workshop/#docker-containers-summary","title":"Docker Containers Summary","text":"Filename Purpose <code>docker-compose-dbs-empty.yml</code> Runs EMPTY PostgreSQL and Elastic <code>docker-compose-dbs.yml</code> Runs PRE-POPULATED PostgreSQL and Elastic <code>docker-compose-gn4.yml</code> Runs GN4 (requires running PostgreSQL and Elastic) <code>docker-compose-gn5.yml</code> Runs GN5 (requires running PostgreSQL and Elastic) <code>docker-compose-web.yml</code> Runs Angular application for OGCAPI-RECORDS GUI (requires running GN5)"},{"location":"Developer/workshop/#workshop-1","title":"Workshop 1","text":"<p>Before starting Workshop 1, ensure that you have PostgreSQL and Elastic running, and have some sample data loaded.</p> <pre><code>git clone https://github.com/geonetwork/geonetwork.git\ncd geonetwork\ngit checkout dev # might not be necessary\nmvn clean install -Drelax\ncd src/app/workshop/workshop1\n</code></pre> <p>From here you can:</p> <ol> <li> <p>Run GN5 from the command line</p> <pre><code>mvn spring-boot:run\n</code></pre> </li> <li> <p>OR, run it from your IDE</p> </li> </ol>"},{"location":"Developer/workshop/#endpoints","title":"Endpoints","text":"<ul> <li>http://localhost:7979/geonetwork/workshop1</li> <li>http://localhost:7979/geonetwork/workshop1b</li> <li>http://localhost:7979/geonetwork/workshop1c</li> <li>http://localhost:7979/geonetwork/workshop1d</li> <li>http://localhost:7979/geonetwork/workshop1e</li> </ul> <p>OpenAPI (swagger) endpoints (for use with the <code>workshop1e</code> endpoint):</p> <ul> <li>http://localhost:7979/geonetwork/v3/api-docs?f=json JSON version of the OpenAPI document</li> <li>http://localhost:7979/geonetwork/swagger-ui/index.html HTML version of teh OpenAPI document</li> </ul> Endpoint What it does <code>workshop1</code> returns hardcoded trivial hello-world <code>String</code> <code>workshop1b</code> returns hardcoded <code>Map&lt;String,Long&gt;</code> <code>workshop1c</code> returns hardcoded <code>GeoNetworkMetadataSummary</code> <code>workshop1d</code> returns with real DB results <code>workshop1e</code> same as workshop1d, but with openapi information"},{"location":"Developer/workshop/#code","title":"Code","text":"<p>All the code for this is in the <code>WorkshopController</code> class.  </p>"},{"location":"Developer/workshop/#workshop-2","title":"Workshop 2","text":"<p>The main differences between <code>workshop1_app</code> and <code>workshop2_app</code> are:</p> <ol> <li>Instead of hand-coding our controllers and the controllers response object, we autogenerate them from OpenAPI (swagger) <code>.yml</code> files</li> <li>We use the full <code>src/app</code>, <code>src/module</code>, and <code>src/shared</code> source layout</li> <li>We use more spring-oriented Repository access (DB)</li> </ol>"},{"location":"Developer/workshop/#source-code-layout-srcapp-srcmodule-and-srcshared","title":"Source code layout (<code>src/app</code>, <code>src/module</code>, and <code>src/shared</code>)","text":"Location Content <code>src/app</code> This is the application - typically, it only contains a <code>pom.xml</code> to manage \"pulling in\" dependencies <code>src/module</code> This is where the spring controllers are defined.  In this example it contains two modules - one that auto-generates controller interface and response objects from OpenAPI <code>.yml</code> documents.  It also contains a trivial implementation of the controller API that \"hands off\" the work to a class in <code>src/shared</code> <code>src/shared</code> This is where the actual code goes.  In this case, it accesses the database and creates the actual response object.  It can use other GN5 code by depending on other <code>/src/shared</code> modules."},{"location":"Developer/workshop/#see-other-areas","title":"See Other Areas","text":"<ul> <li>New Application Development</li> </ul>"},{"location":"GN4-Integration/","title":"GeoNetwork 5 Integration with GeoNetwork 4","text":"<p>During the development of GN5, GN4 will be used for some of the GN functionality.  GN5 will route some requests to a GN4 instance (connected to the same DB and Elastic Index) for processing.</p>"},{"location":"GN4-Integration/#setting-up-gn5-and-gn4","title":"Setting up GN5 and GN4","text":"<ol> <li>Configure GN5 (<code>application.yml</code>) so that the <code>cloud: gateway: mvc:</code> configuration points to your GN4</li> <li> <p>Ensure that GN4 is setup to be proxied:</p> <p>a) Go the GN4's settings (\"Catalog server\" section)  b) Set this section up so it will create urls that will be correctly routed through GN5 (ie. use GN5's hostname and port) c) Your GN4's path should be the same as the GN5's proxy path.  This will ensure that GN4's session cookies are correctly maintained    For example, GN5's proxy at <code>http://&lt;host&gt;:&lt;port&gt;/geonetwork</code> and GN4 at <code>http://&lt;other host&gt;:&lt;other port&gt;/geonetwork</code>    (both at <code>/geonetwork</code>)</p> </li> <li> <p>Configure GN4 with JWT Headers Security and add the GN5 <code>application.yml</code> <code>cloud: gateway: mvc:</code> filter.</p> <p>a) JWT-Based Authentication - recommended for most installations  b) Simple Authentication - easier to configure, but GN4 must not be accessible via the internet or intranet.</p> </li> </ol> <p>You will manage users in the GN database.</p>"},{"location":"GN4-Integration/#using-github-oidc-authentication","title":"Using GitHub OIDC Authentication","text":"<p>Typically, you would use the standard username/password authentication thats built into GN5.  However, GitHub authentication is also available.</p> <ol> <li>Create a GitHub application (this will give you a <code>clientId</code>).  Got to https://github.com/settings/profile then \"Developer settings\" (left column) then \"OAuth Apps\" (left column).  See online tutorials on how to create one.<ul> <li>\"Authorization callback URL\" -  http://localhost:7979/login/oauth2/code/github (use your GN5's host address)</li> </ul> </li> <li>Create a GitHub clientSecret (this will give you a <code>clientSecret</code>)</li> <li> <p>Add the <code>clientId</code> and <code>clientSecret</code> to GN5's <code>application.yml</code> section <code>security: oauth2: client: registration: github:</code></p> <ul> <li>fill in the  <code>clientId:</code> and <code>clientSecret:</code> sections</li> <li>choose the attribute name to use as the GeoNetwork username</li> </ul> </li> </ol> <pre><code> security:\n    oauth2:\n      client:\n        registration:\n          github:\n            clientId:  ...from your GitHub application...\n            clientSecret: ...from your GitHub application...\n        # this is optional: \n        provider:\n          github:\n            user-name-attribute: login\n</code></pre> <p>You can also customize how the user is created in the GeoNetwork database from attributes in the OIDC/OAUTH2 user from the IDP:</p> <pre><code>geonetwork:\n  security:\n    oauth2:\n      registration:\n        github:\n          email: email\n          name: login\n          organization: company\n          surname: lastname\n        custom:\n          email: email\n          name: first_name\n          organization: company\n          surname: last_name\n</code></pre> <p>One the main GN5 (http://localhost:7979) click \"GitHub\" and you will be redirected for GitHub's authentication.</p> <p>Once the user logs into GN5, it will create a user in the database.  The username will either be their email (if they have configured GitHub to have their email address public) or their GitHub username.</p> <p>Use the tools in the GN Administration -&gt; \"Users and Groups\" to set the user's permissions.</p>"},{"location":"GN4-Integration/auth-json/","title":"Simple Authentication between GN4 and GN5 with JSON","text":"<p>[!WARNING] If your GN4 is accessible through other means than GN5 (i.e. via the internet or intranet), use the JWT version. A malicious actor can add a header to the requests and directly communicate with GN4.  GN4 would then trust this header.</p>"},{"location":"GN4-Integration/auth-json/#gn5-setup","title":"GN5 setup","text":"<p>In <code>application.yml</code> (cloud: gateway: mvc), add the \"filters\" (at the bottom): <pre><code>  cloud:\n    gateway:\n      mvc:\n        routes:\n          - id: geonetwork_route\n            uri: ${geonetwork.4.url}\n            predicates:\n              - Path=/geonetwork/**\n            filters:\n              - addSimpleGn4SecurityHeader=gn5.to.gn4.trusted.json.auth\n</code></pre> <code>gn5.to.gn4.trusted.json.auth</code> is the name of the header that will be attached to the requests so auth is recognized by GN4's JWT Headers Security module (see below).</p> <p>This header will, typically, look like this:</p> <pre><code>{\n      \"username\":\"david\"\n}      \n</code></pre>"},{"location":"GN4-Integration/auth-json/#gn4-setup","title":"GN4 setup","text":"<ol> <li>You will need the JWT Headers security model (available in the latest GN4)</li> <li>Set it up with the environment variables, see below.</li> <li>Run with JWT Headers enabled <code>-Dgeonetwork.security.type=gn5</code></li> <li> <p>GN4 must NOT be accessible other than via the GN4 Gateway proxy.  GN4 is trusting headers so they must be removed.</p> </li> <li> <p>If GN4 is available, you MUST remove the <code>gn5.to.gn4.trusted.json.auth</code> header from incoming requests (typically done with your webserver)</p> </li> </ol> <pre><code>JWTHEADERS_UserNameHeaderName=gn5.to.gn4.trusted.json.auth\nJWTHEADERS_UserNameFormat=JSON\nJWTHEADERS_UserNameJsonPath=username\nJWTHEADERS_JwtHeaderRoleSource=DB\nJWTHEADERS_UpdateProfile=false\nJWTHEADERS_UpdateGroup=false\n</code></pre> <p>Environment variables meaning:</p> <ul> <li><code>JWTHEADERS_UserNameHeaderFormat</code>  - name of the header to use (should be the same as your GN5 <code>application.yml</code> filter config)</li> <li><code>JWTHEADERS_UserNameFormat</code> - should be JSON (the header is a JSON string)</li> <li><code>JWTHEADERS_UserNameJsonPath</code> - where in the JSON is the username</li> <li><code>JWTHEADERS_JwtHeaderRoleSource</code> - this should be <code>DB</code> (GN DB will manage user-profile-groups)</li> <li><code>JWTHEADERS_UpdateProfile</code> -  JWT Headers should NOT update the DB profiles (user allowed to edit in GUI)</li> <li><code>JWTHEADERS_UpdateGroup</code> -  JWT Headers should NOT update the DB user-groups (user allowed to edit in GUI)</li> </ul> <p>See the GN JWT Headers documentation for more info.</p> <p>In <code>config-security.properties</code>, configure the URLs for login and logout to point to GN5:</p> <pre><code>logout.success.url=http://localhost:7979/geonetwork/srv/eng/catalog.search\nloginForm=http://localhost:7979/geonetwork/srv/eng/catalog.signin\nloginErrorForm=http://localhost:7979/geonetwork/srv/eng/catalog.signin?failure=true\n</code></pre> <p>In UI configuration, you need to enable the authentication and set the signin/signout URLs to use the GN5 URLs:</p> <pre><code>     \"authentication\": {\n          \"enabled\": true,\n          \"signinUrl\": \"../../{{node}}/{{lang}}/catalog.signin\",\n          \"signinAPI\": \"../../api/user/signin\",\n          \"signoutUrl\": \"../../api/user/signout\"\n</code></pre>"},{"location":"GN4-Integration/auth-jwt/","title":"Secure Authentication between GN4 and GN5 with JWT","text":""},{"location":"GN4-Integration/auth-jwt/#securing-gn5-to-gn4-with-signed-jwt","title":"Securing GN5 to GN4 with signed JWT","text":"<p>A more secure way to secure send information to GN4 is to use signed JWT.  GN4 will verify they are correctly signed and prevent a malicious actor from faking a GN4 authentication token.</p> <p>To set this up:</p> <ol> <li>Generate an RSA private and public key</li> <li>Create a JWK Set containing the public key</li> <li>Configure GN5</li> <li>Configure GN4</li> </ol>"},{"location":"GN4-Integration/auth-jwt/#generate-an-rsa-private-and-public-key","title":"Generate an RSA private and public key","text":"<pre><code>openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout private.key -out certificate_pub.crt\n</code></pre> <p>This will generate:</p> <ol> <li><code>private.key</code> - use this in GN5.  Put this where it is accessible to GN5.  This must be secured since the private key is sensitive.</li> <li><code>certificate_pub.crt</code> - use this in the next step for GN4.  Put this where it is accessible to GN4.</li> </ol>"},{"location":"GN4-Integration/auth-jwt/#create-a-jwk-set-containing-the-public-key","title":"Create a JWK Set containing the public key","text":"<p>The standard way of handling JWT signature validation is to use a JWK Set.  This is fairly easy to do.</p> <p>[!WARNING] If you get an error like <code>ParseException: Missing required \"keys\" member</code> then you've likely forgotten to do the last step (impeding your JWK into another JSON file) that turns the generated JWK into a JWK Set.</p> <ol> <li>Use https://jwkset.com/generate to convert your <code>certificate_pub.crt</code> to a JWK.   a. copy the text from <code>certificate_pub.crt</code> into the first section - \"<code>PEM encoded key or certificate</code>\"    b. choose a <code>Key ID</code> (you'll need this, below)   c. <code>Key Algorithm</code> is \"RSA256\"   d. <code>Key Use</code> is \"Signature\"   e. Press \"Generate\"</li> <li>Create a file using the output JWT in the following format: <pre><code>{\n    \"keys\": [\n         ... TEXT FROM ABOVE ...\n    ]\n}\n</code></pre></li> <li>Save the file and make it accessible by GN4</li> </ol> <p>NOTE: There are other online/offline tools that do this.</p>"},{"location":"GN4-Integration/auth-jwt/#configure-gn5","title":"Configure GN5","text":"<p>In <code>application.yml</code>:</p> <pre><code>  cloud:\n    gateway:\n      mvc:\n        routes:\n         ...\n            filters:\n              - addSimpleJwtGn4SecurityHeader=gn5.to.gn4.trusted.json.auth,file:///Users/db/delme/key/private.key,mykeyid\n</code></pre> <p>The parameters to the <code>addSimpleJwtGn4SecurityHeader</code> filter are:  a) name of the header to use (must be the same as the GN4 configuration) b) URL to the private key (<code>private.key</code> generated above) c) Name of the <code>Key ID</code> (from above)</p>"},{"location":"GN4-Integration/auth-jwt/#configure-gn4","title":"Configure GN4","text":"<p>Sent environment variables like this;</p> <p>[!WARNING] If you are getting errors (especially about the JWT not being valid), the most likely issue is with these settings.  Please double check them.</p> <pre><code>JWTHEADERS_ValidateTokenAudienceClaimValue=g4.from.g5.proxy\nJWTHEADERS_ValidateTokenAudience=true\nJWTHEADERS_ValidateTokenAudienceClaimName=aud\nJWTHEADERS_ValidateTokenExpiry=true\nJWTHEADERS_ValidateToken=true\nJWTHEADERS_ValidateTokenSignatureURL=file:///Users/db/delme/jws.json\nJWTHEADERS_UpdateProfile=false\nJWTHEADERS_UpdateGroup=false\nJWTHEADERS_RolesHeaderName=gn5.to.gn4.trusted.json.auth\nJWTHEADERS_UserNameFormat=JWT\nJWTHEADERS_JwtHeaderRoleSource=DB\nJWTHEADERS_UserNameJsonPath=username\nJWTHEADERS_ValidateTokenAgainstURL=false\nJWTHEADERS_UserNameHeaderName=gn5.to.gn4.trusted.json.auth\n</code></pre>"},{"location":"GN4-Integration/auth-jwt/#audience-validation","title":"Audience Validation","text":"<p>This audience is put into the JWT by GN5.  It's optional (but recommended) to validate it.</p> <p><code>JWTHEADERS_ValidateTokenAudienceClaimValue=g4.from.g5.proxy</code> <code>JWTHEADERS_ValidateTokenAudience=true</code> <code>JWTHEADERS_ValidateTokenAudienceClaimName=aud</code></p>"},{"location":"GN4-Integration/auth-jwt/#token-expiry","title":"Token Expiry","text":"<p>Ensure the token hasn't expired yet.</p> <p><code>JWTHEADERS_ValidateTokenExpiry=true</code></p>"},{"location":"GN4-Integration/auth-jwt/#validate-signature","title":"Validate Signature","text":"<p>This should be URL to the JWK Set you created, above. NOTE: see below if you are using a file instead of a https location</p> <p><code>JWTHEADERS_ValidateTokenSignatureURL=file:///Users/db/delme/jws.json</code></p>"},{"location":"GN4-Integration/auth-jwt/#other-configuration","title":"Other configuration","text":"<p>This is the meaning of the other configuration options:</p> <p><code>JWTHEADERS_UserNameFormat=JWT</code> -- expect identity information to be in a JWT</p> <p><code>JWTHEADERS_UserNameJsonPath=username</code> -- json path (inside the JWT payload) of the username <code>JWTHEADERS_ValidateTokenAgainstURL=false</code> -- do not validate the token against the IDP <code>JWTHEADERS_UserNameHeaderName=gn5.to.gn4.trusted.json.auth</code>- name of the request header containing the JWT.  Must be the same as the GN5 configuration.</p> <p><code>JWTHEADERS_UpdateProfile=false</code> - manage user permissions and groups in the DB <code>JWTHEADERS_UpdateGroup=false</code>- manage user permissions and groups in the DB <code>JWTHEADERS_JwtHeaderRoleSource=DB</code> - manage user permissions and groups in the DB</p>"},{"location":"GN4-Integration/auth-jwt/#jwk-set-in-file","title":"JWK Set in File","text":"<p>The older implementation of JWT Headers isn't compatible with file-base URLs for the JWKSet.  This is fixed, but it will take a while for this to become \"official\" through the build chains.</p> <p>Use <code>python</code> to serve your JWK Set file;</p> <ol> <li>make a directory and put the JWK Set json file in it</li> <li>run:    <code>python3 -m http.server 9000</code></li> <li>Use \"http://localhost:9000/jwksets.json\" as the JWK Set url</li> </ol> <p>See the python documentation for security related to doing this.</p>"},{"location":"OGCAPI-Records/","title":"GeoNetwork 5 OGCAPI-Records","text":"<p>GeoNetwork 5 has an OGCAPI-Records implementation.</p> Run the OGCAPI-Records Demo Server Start Here!The best way to learn how to setup an OGCAPI-Records Server is to run the demo server.  This tutorial explains how to setup everything - PostgreSQL, Elastic, GeoNetwork 4, and GeoNetwork 5. It also shows how to connect metadata records to collections/catalogs/sources. Learn about the Extra Functionality GeoNetwork 5's OGCAPI-Records has some extra functionality to make users happy! Minor Differences with Specification There are some very minor differences between GN5's implementation and the specification. Configuring GN5's OGCAPI-Records Learn about some of the configuration options. Deploying GN5's OGCAPI-Records See some of the configuration options for easier deployment Learn some technical details For developers, this is a technical overview of the implementation. Content Negotiation and Profiles For developers, this is a technical overview of the implementation."},{"location":"OGCAPI-Records/config/","title":"Config","text":""},{"location":"OGCAPI-Records/config/#ogcapi-records-configuration-and-deployment","title":"OGCAPI-Records Configuration and Deployment","text":"<p>Most of the configuration for the OGCAPI-Records module are in the <code>application.yaml</code> (key: <code>geonetwork: openapi-records:</code>).  There are two sections - <code>links</code> and <code>search</code>.</p>"},{"location":"OGCAPI-Records/config/#links-section","title":"Links Section","text":"<p>The links section defines how the different OGCAPI-Records object have links in them.  Its unlikely you will need to modify this, however, there are two properties that will change for deployments.</p> property meaning ogcApiRecordsBaseUrl This the base url of the GN5 OGCAPI-Records installation.  It defaults to <code>http://localhost:7979/ogcapi-records/</code>. This is useful so links point to the correct location even if your OGCAPI-Records server is behind a reverse proxy. gnBaseUrl This is the base URL used for getting icons from GeoNetwork.  It defaults to <code>http://localhost:7979/geonetwork</code>.  You can either point to the GN5 proxied GN4 or directly to a running GN4."},{"location":"OGCAPI-Records/config/#search-section","title":"Search Section","text":"<p>The search section defines some configuration for how he GN5 OGCAPI-Record interacts with Elastic.</p> property meaning queryFilter This query filter is always added to all queries.  The default value is <code>+isTemplate:n</code> (do not return metadata record templates). queryBase When executing a normal <code>q=...</code> query, this defines how we do an elastic search.  The default value is <code>'(any.\\*:(${any}) OR resourceTitleObject.\\*:(${any})^2)'</code> (search <code>any</code> and <code>title</code>.  Give priority to <code>title</code> matches). trackTotalHits Should the elastic query track total hits?  Tracking total hits is expensive, however, is needed for paging. The default value is <code>true</code>. sources What elastic index json record sources (properties) should be retrieved during a query?   The default value is <code>[*]</code> (return all sources)."},{"location":"OGCAPI-Records/content-negotiation/","title":"Content Negotiation and Profiles","text":"<p>The GN5 OGCAPI-Records is integrated with the GN5 <code>FormatterApi</code>.  This allows outputting of various formats (like JSON, XML, and DCAT) for a record.</p> <p>There are two types of Formatters available:</p> <ol> <li>XSLT-Based Formatters</li> </ol> <p>Most formatters are of this type - they take the underlying XML and run a XSLT transformation to get the output.  These XSLTs need to be defined on a per-schema basis.  </p> <p>You can use the <code>FormatterApi</code> endpoints to see what is available (and for what schemas) - see the <code>FormatterController</code> and the <code>FormatterApi</code>.  A useful summary of available formatter is at http://localhost:7979/api/records/formatters.</p> <ol> <li>Elastic JSON Index-Based Formatters</li> </ol> <p>There are a few formatters (most notably the <code>ogcapi-record</code> JSON output) use the information in the Elastic JSON Index to create output.  This index is a schema-independent simple representation of the underlying metadata record (which is usually XML).  This is only used for simple output formats as a lot of information in the underlying XML record is lost.</p>"},{"location":"OGCAPI-Records/content-negotiation/#selecting-the-content","title":"Selecting the Content","text":"<p>In general, you can add <code>?f=&lt;mime type&gt;</code> to OGCAPI-Records requests to get content in a specific format.  For actual records, you can also request a Profile.</p> <p>For example;</p> <p>http:/localhost:7979/ogcapi-records/collections/1402ea86-2900-4cf7-b58a-f8d78bc051e4/items/51c6b2ac-3658-40b3-9a8f-0131ee74443f?f=application%2Frdf%2Bxml&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Feu-dcat-ap-hvd</p> <p>We are requesting MimeType <code>application/rdf</code> (DCAT RDF) with the profile <code>http://geonetwork.net/def/profile/eu-geodcat-ap</code> (url encoded).</p>"},{"location":"OGCAPI-Records/content-negotiation/#default-profiles-for-mime-types","title":"Default Profiles for Mime Types","text":"<p>You can set default Profiles for a Mime Types in the <code>application.yaml</code> file (<code>geonetwork</code>.<code>openapi-records</code>.<code>links</code>.<code>item</code>):</p> <pre><code>profileDefaults:\n    - mimetype: application/geo+json\n        defaultProfile: http://www.opengis.net/def/profile/OGC/0/ogc-record\n    - mimetype: application/rdf+xml\n        defaultProfile: http://geonetwork.net/def/profile/dcat\n    - mimetype: application/xml\n        defaultProfile: http://geonetwork.net/def/profile/raw-xml\n    - mimetype: application/json\n        defaultProfile: http://geonetwork.net/def/profile/elastic-json-index\n</code></pre> <p>If someone doesn't put a Profile in the request, then this will choose the profile.</p>"},{"location":"OGCAPI-Records/content-negotiation/#links","title":"Links","text":"<p>When requesting in the <code>ogcapi-record</code> JSON format, Record documents will have links like:</p> <pre><code> \"links\": [\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/xml\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/raw-xml\"\n      ],\n      \"href\": \"http:/localhost:7979/ogcapi-records/collections/1402ea86-2900-4cf7-b58a-f8d78bc051e4/items/51c6b2ac-3658-40b3-9a8f-0131ee74443f?f=application%2Fxml&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Fraw-xml\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/xml\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/datacite\"\n      ],\n      \"href\": \"http:/localhost:7979/ogcapi-records/collections/1402ea86-2900-4cf7-b58a-f8d78bc051e4/items/51c6b2ac-3658-40b3-9a8f-0131ee74443f?f=application%2Fxml&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Fdatacite\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/json\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/elastic-json-index\"\n      ],\n      \"href\": \"http:/localhost:7979/ogcapi-records/collections/1402ea86-2900-4cf7-b58a-f8d78bc051e4/items/51c6b2ac-3658-40b3-9a8f-0131ee74443f?f=application%2Fjson&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Felastic-json-index\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/rdf+xml\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/eu-dcat-ap-hvd\"\n      ],\n      \"href\": \"http:/localhost:7979/ogcapi-records/collections/1402ea86-2900-4cf7-b58a-f8d78bc051e4/items/51c6b2ac-3658-40b3-9a8f-0131ee74443f?f=application%2Frdf%2Bxml&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Feu-dcat-ap-hvd\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/rdf+xml\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/eu-geodcat-ap\"\n      ],\n      \"href\": \"http:/localhost:7979/ogcapi-records/collections/1402ea86-2900-4cf7-b58a-f8d78bc051e4/items/51c6b2ac-3658-40b3-9a8f-0131ee74443f?f=application%2Frdf%2Bxml&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Feu-geodcat-ap\"\n    },\n    ...\n]\n ```\n\n Notice that the link's `href` has a `&amp;profile...` part. If it is missing, the system will choose the default profile for that mime type (configured inside `application.yaml`)\n\n Looking at the `RDF+XML` content type in the links, above:\n ```\n{\n      \"rel\": \"alternative\",\n      \"type\": \"application/rdf+xml\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/eu-dcat-ap-hvd\"\n      ],\n      \"href\": \"http:/localhost:7979/ogcapi-records/collections/1402ea86-2900-4cf7-b58a-f8d78bc051e4/items/51c6b2ac-3658-40b3-9a8f-0131ee74443f?f=application%2Frdf%2Bxml&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Feu-dcat-ap-hvd\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/rdf+xml\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/eu-geodcat-ap\"\n      ],\n      \"href\": \"http:/localhost:7979/ogcapi-records/collections/1402ea86-2900-4cf7-b58a-f8d78bc051e4/items/51c6b2ac-3658-40b3-9a8f-0131ee74443f?f=application%2Frdf%2Bxml&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Feu-geodcat-ap\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/rdf+xml\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/dcat\"\n      ],\n      \"href\": \"http:/localhost:7979/ogcapi-records/collections/1402ea86-2900-4cf7-b58a-f8d78bc051e4/items/51c6b2ac-3658-40b3-9a8f-0131ee74443f?f=application%2Frdf%2Bxml&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Fdcat\"\n    },\n    {\n      \"rel\": \"alternative\",\n      \"type\": \"application/rdf+xml\",\n      \"hreflang\": \"eng\",\n      \"profile\": [\n        \"http://geonetwork.net/def/profile/eu-dcat-ap\"\n      ],\n      \"href\": \"http:/localhost:7979/ogcapi-records/collections/1402ea86-2900-4cf7-b58a-f8d78bc051e4/items/51c6b2ac-3658-40b3-9a8f-0131ee74443f?f=application%2Frdf%2Bxml&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Feu-dcat-ap\"\n    },\n</code></pre> <p>This shows that there are 4 profiles available (all in url format):</p> <ul> <li><code>http://geonetwork.net/def/profile/eu-dcat-ap-hvd</code></li> <li><code>http://geonetwork.net/def/profile/eu-geodcat-ap</code></li> <li><code>http://geonetwork.net/def/profile/dcat</code></li> <li><code>http://geonetwork.net/def/profile/eu-dcat-ap</code></li> </ul> <p>NOTE: these will likely change to a more authoritative URL.</p> <p>To get the <code>http://geonetwork.net/def/profile/eu-dcat-ap</code> profile, use:</p> <pre><code>http://localhost:7979/ogcapi-records/collections/&lt;collectionId&gt;/items/&lt;itemId&gt;?f=application/rdf+xml&amp;profile=http%3A%2F%2Fgeonetwork.net%2Fdef%2Fprofile%2Feu-geodcat-ap\n</code></pre> <p>NOTE: the profile name (url) has been url-encoded</p> <p>To get the default (defined in <code>application.yaml</code>) profile, use:</p> <pre><code>http://localhost:7979/ogcapi-records/collections/&lt;collectionId&gt;/items/&lt;itemId&gt;?f=application/rdf+xml\n</code></pre>"},{"location":"OGCAPI-Records/content-negotiation/#headers","title":"Headers","text":"<p>When requesting a Record (<code>item</code> endpoint), a <code>Link</code> header will be set in this manner:</p> <pre><code>HTTP/1.1 200\nContent-Type: application/rdf+xml\nLink: &lt;http://geonetwork.net/def/profile/eu-geodcat-ap&gt;; rel=\"profile\"\n</code></pre> <p>Or, for the standard OGCAPI-Records <code>ogcapi-record</code> output:</p> <pre><code>HTTP/1.1 200\nContent-Type: application/json\nLink: &lt;http://www.opengis.net/def/profile/OGC/0/ogc-record&gt;; rel=\"profile\"\n</code></pre>"},{"location":"OGCAPI-Records/content-negotiation/#more-information","title":"More Information","text":"<p>See the OGCAPI-Records specification.</p> <p>See this discussion on OGCAPI-Records and Profiles.</p>"},{"location":"OGCAPI-Records/content-negotiation/#technical-discussion-of-content-negotiation","title":"Technical Discussion of Content Negotiation","text":"<p>This is a technical discussion of how the Content Negotiation is working in the OGCAPI-Records and how it integrates with Spring Boot.</p> <p>One of the difficulties is that there are multiple output \"profiles\" for a single mime type.  For example, <code>application/rdf+xml</code> (i.e. DCAT) has several \"flavours\" of output (i.e. GEODCAT, DCAT, and country-specific DCAT-AP).  This is a bit more advanced for how spring boot does its Content Negotiation.</p>"},{"location":"OGCAPI-Records/content-negotiation/#simple-spring-boot-content-negotiation","title":"Simple Spring Boot Content Negotiation","text":"<p>In a typical spring boot application, there is a 1:1 correlation between the mime type in the request (i.e. either an <code>Accepts: ...</code> header or a <code>?f=&lt;mime type&gt;</code> parameter). </p> <p>This is setup with the <code>ContentNegotiationConfigurer</code> (cf. <code>WebConfig.java</code>) and registering a set of <code>HttpMessageConverter</code>.</p> <p><code>ContentNegotiationConfigurer</code> - This sets up how spring processes incoming requests and determines what Mime Type to use.  For example, it converts <code>&amp;f=json</code> into <code>application/json</code>.</p> <p><code>HttpMessageConverter</code> - These convert an object (i.e. result from the controller endpoint) into the corresponding Mime Type format.  Typically, for an <code>application/json</code> request, it will use the Jackson <code>ObjectMapper</code> to convert to an actual JSON string.</p> <p>In summary, the typical spring boot content negotiation is:</p> <p>a) controller's result object - this is the main work of the OGCAPI-Records codebase   b) user's requested Mime Type - the <code>ContentNegotiationConfigurer</code> determines this   c) respond with the converted result object - this is done with a <code>HttpMessageConverter</code> </p> <p>Spring boot will take the incoming request, determines the requested MimeType (<code>ContentNegotiationConfigurer</code>), then execute the controller endpoint.  The result object is then passed to the correct <code>HttpMessageConverter</code> which will write the output to the Http Response.</p> <p>NOTE:</p> <p>If you look at the <code>HttpMessageConverter</code>, its only really given the controllers result object and the Mime Type.  Is very disconnected from the original request.</p>"},{"location":"OGCAPI-Records/content-negotiation/#gn5s-ogcapi-records-content-negotiation","title":"GN5's OGCAPI-Records Content Negotiation","text":"<p>There are a few complexities with OGCAPI-Records and how its integrated into the GN5 <code>FormatterApi</code>.  </p> <ol> <li>The output configuration is dynamic - OGCAPI-Records doesn't apriori know the MimeType (and profiles) that it supports.</li> <li>The output requires both the MimeType (i.e. <code>application/rdf+xml</code>) and a profile (i.e. <code>dcat-ap-nl</code>).</li> </ol> <p>The OGCAPI team recently added support for profiles (and profile negotiation).</p> <p>Internally, on startup, the <code>FormatterApi</code> is queried for the supported MimeTypes (cf. <code>WebConfig.java</code>) and the <code>FormatterApiMessageWriter</code> is created.</p> <p><code>FormatterApiMessageWriter</code> is configured (by querying the <code>FormatterApi</code>) with what Mime Types it supports.  It, also, only knows how to process <code>OgcApiRecordsRecordGeoJSONDto</code> objects.  This object is a single metadata record (i.e. from the <code>/collections/&lt;CollectionId&gt;/items/&lt;ItemId&gt;</code> endpoint).</p> <p>The main problem is that the <code>FormatterApiMessageWriter</code> doesn't have access to the user's request - just the expected Mime Type and the <code>OgcApiRecordsRecordGeoJSONDto</code> object.  The main issue is that it doesn't know what profile the user requested.</p> <p>Currently, I've modified the Controller and have it add information to the output headers (which is available both to the controller and the <code>HttpMessageConverter</code>).  This is a bit of a hack.</p> <p>Alternative Hacks:</p> <ol> <li>add a <code>\"requestedProfiles\"</code> field to the <code>OgcApiRecordsRecordGeoJSONDto</code> object</li> <li>try to put the information into a thread local or try to get access to the current http request</li> <li>try to set \"strange\" mime types that could be parsed by the <code>FormatterApiMessageWriter</code></li> </ol> <p>None of these solutions is great - please let us know if there are other, better, options.</p> <p>NOTE:  The implementation uses spring's <code>BeanFactory</code> to break some implied circular dependencies.  This is mostly because of the <code>WebConfig -&gt; Formatter -&gt; Index Formatter - &gt; Elastic Indexing -&gt; WebConfig</code> chain.</p>"},{"location":"OGCAPI-Records/demo-server/","title":"Demo server","text":""},{"location":"OGCAPI-Records/demo-server/#setting-up-a-demo-ogcapi-records","title":"Setting up a demo OGCAPI-Records","text":"<p>In order to run OGCAPI-Records, you will need:</p> <ol> <li>PostgreSQL/PostGIS database</li> <li>Elastic Search (recommend v8.14)</li> <li>GN4</li> <li>GN5</li> </ol>"},{"location":"OGCAPI-Records/demo-server/#setting-up-postgresql","title":"Setting up PostgreSQL","text":"<p>This container (<code>kartoza/postgis:16-3.4</code>) is for an M1 mac - use a different docker container for an X64 machine.</p> <pre><code>docker run -p 5432:5432 -e POSTGRES_PASS=postgres -e POSTGRES_USER=postgres   kartoza/postgis:16-3.4\nPGPASSWORD=postgres psql -h localhost -U postgres -d template1 -c \"create database gn;\"\nPGPASSWORD=postgres psql -h localhost -U postgres -d gn -c \"create extension postgis;\"\n\n\nPGPASSWORD=postgres psql -h localhost -U postgres -d gn -c \"CREATE USER \\\"www-data\\\" WITH SUPERUSER PASSWORD 'www-data';\"\n</code></pre> <p>This will:</p> <ol> <li>run the <code>docker</code> PostgreSQL/PostGIS container (available on PORT 5432).  The admin user will be postgres/postgres.</li> <li>create a database called <code>gn</code></li> <li>add the PostGIS extension to the database</li> <li>add a super user with name <code>www-data</code> and password <code>www-data</code>.</li> </ol> <p>These settings should match what is in your GN5 <code>application.yml</code> file.</p> <p>To run a <code>psql</code> session:</p> <pre><code>PGPASSWORD=postgres psql -h localhost -U postgres -d gn \n</code></pre>"},{"location":"OGCAPI-Records/demo-server/#setup-elastic-search-recommend-v814","title":"Setup Elastic Search (recommend v8.14)","text":"<p>This will run an elastic search docker container (v8.14.0) on port 9200.</p> <pre><code>docker run -p 9200:9200 -p 9300:9300 -e \"discovery.type=single-node\" -e \"xpack.security.enabled=false\" -e \"xpack.security.enrollment.enabled=false\" docker.elastic.co/elasticsearch/elasticsearch:8.14.0\n</code></pre> <p>This does not have any indexes in it - when you run GN4 (see below) it will add the indexes.</p> <p>Here are some interesting URLs:</p> <ol> <li>http://localhost:9200/ Cluster URL</li> <li>http://localhost:9200/gn-records/_search?pretty=true&amp;q=: All records in the index</li> <li>http://localhost:9200/gn-records/_search?pretty=true&amp;q=_id:ce6dc729-7ec0-4ba9-baf8-4bc1525120c8 Show a particular record (by metadata ID)</li> <li>http://localhost:9200/gn-records The index definition (advanced users only!)</li> </ol>"},{"location":"OGCAPI-Records/demo-server/#setup-gn4","title":"Setup GN4","text":"<p>Run GeoNetwork 5 connected to the PostgreSQL/PostGIS database.  The easiest way to do this is to checkout and build GN4 from source.</p> <pre><code>cd web\nmvn jetty:run -Dgeonetwork.db.type=postgres-postgis -Djdbc.database=gn -Djdbc.username=www-data -Djdbc.password=www-data -Djdbc.host=localhost -Ddb.port=5432 -Djdbc.port=5432\n</code></pre>"},{"location":"OGCAPI-Records/demo-server/#demo-gn4-setup","title":"DEMO GN4 setup","text":"<p>Here are some steps to take to setup some data in GN4.  This demo will include the 5 iso19139 sample records supplied with GN4 and two extra ones we will use to annotate geonetwork portals (Also called <code>sources</code> in GeoNetwork and <code>collections</code> or <code>catalogs</code> in OGCAPI-Records).</p> <p>We then create a sub-portal (called \"subportal\") and attach the <code>subportal.xml</code> record to it.</p> <p>We then attach the <code>main.xml</code> record to the main portal.</p>"},{"location":"OGCAPI-Records/demo-server/#setup-records","title":"Setup Records","text":"<ol> <li>Login as admin http://localhost:8080/geonetwork</li> <li>Go to <code>Admin console</code> -&gt; <code>Metadata and Templates</code><ul> <li>Tick <code>Geographic information -- Metadata (iso19139:2007) (iso19139)</code> and press <code>Load samples for selected standards</code></li> </ul> </li> <li>Download main.xml and subportal.xml which are two extra sample metadata records.</li> <li>Go to <code>Contribute</code> -&gt; <code>Import New Records</code><ul> <li>Tick <code>Publish</code></li> <li>Choose the <code>main.xml</code> you downloaded (above) (use <code>Choose or drop resource here</code>)</li> <li>Press <code>Import</code></li> </ul> </li> <li>Go to <code>Contribute</code> -&gt; <code>Import New Records</code><ul> <li>Tick <code>Publish</code></li> <li>Choose the <code>subportal.xml</code> you downloaded (above) (use <code>Choose or drop resource here</code>)</li> <li>Press <code>Import</code></li> </ul> </li> </ol> <p>At this point you should have 7 records in your GN4 installation.</p>"},{"location":"OGCAPI-Records/demo-server/#setup-portals","title":"Setup Portals","text":"<ol> <li>Login as admin http://localhost:8080/geonetwork</li> <li>Go to <code>Admin console</code> -&gt; <code>Settings</code> and choose <code>Sources</code> on the left column.</li> <li>Press \"Add portal\"<ul> <li><code>Identifier</code> - subportal</li> <li><code>Name</code> - SubPortal</li> <li><code>Search Filter</code> - leave this blank, you can modify this later if you want</li> <li><code>Records to use for GetCapabilities</code> - type \"sub\" and then choose the \"GeoCat Demo OGCIAPI sub-portal\" record</li> <li>Choose a logo from the <code>Logo Selection</code></li> <li>Press \"Save\"</li> </ul> </li> <li>On the Left hand column, choose <code>Settings</code><ul> <li>Go down to the \"Catalog Services for the Web\"</li> <li>In the <code>Record to use for GetCapabilities</code>, type \"4e2e361b-02cf-499f-b16e-7eff87925e40\"</li> <li>Press <code>Save Settings</code> (very top)</li> </ul> </li> </ol> <p>NOTE: There's no way to edit the GeoNetwork Source for the main-portal, so we use the CSW GetCapabilities link instead!</p>"},{"location":"OGCAPI-Records/demo-server/#setup-gn5","title":"Setup GN5","text":"<p>You should be able to just run GeoNetwork 5 (from source).  </p> <ol> <li>Checkout GN5 from GitHub</li> <li>Verify that the <code>application.xml</code> (in <code>config/</code>)</li> <li>Build (with java21): <code>mvn clean install -DskipTests</code></li> <li>Run with:</li> </ol> <pre><code>cd src/app/geonetwork\nmvn spring-boot:run\n</code></pre>"},{"location":"OGCAPI-Records/demo-server/#running-the-demo","title":"Running the DEMO","text":"<ol> <li>Go to http://localhost:7979/v3/api-docs?f=json to see the OpenAPI (swagger) documentation.</li> <li>Go to http://localhost:7979/ogcapi-records/?f=json<ul> <li>This is the OGCAPI-Records Landing Page</li> <li>The title should be \"GeoCat Demo OGCIAPI Server\"</li> <li>Notice that it has an extra <code>catalogInfo</code> which contains information taken from <code>main.xml</code></li> </ul> </li> <li>Go to http://localhost:7979/ogcapi-records/collections?f=json<ul> <li>This is the OGCAPI-Records Collections (\"Catalogs\") page</li> <li>There should be two collections - \"GeoCat Demo OGCIAPI Server\" and \"GeoCat Demo OGCIAPI sub-portal\"</li> <li>Notice that the title (and contact) information is coming from the linked metadata records (<code>main.xml</code> and <code>subportal.xml</code>)</li> </ul> </li> <li>Go to http://localhost:7979/ogcapi-records/collections/subportal?f=json<ul> <li>This is the OGCAPI-Records Collection (\"Catalog\") page for the sub-portal collection</li> <li>The metadata about this is coming from the attached <code>subportal.xml</code> record</li> </ul> </li> <li>Go to http://localhost:7979/ogcapi-records/collections/subportal/queryables?f=json<ul> <li>This is the OGCAPI-Records Queryables page for the sub-portal collection</li> <li>This are all the \"extra\" ways you can query the collection</li> <li>Advanced users can see how this is configured in queryables.json.</li> </ul> </li> <li>Go to http://localhost:7979/ogcapi-records/collections/subportal/items?f=json<ul> <li>This is the OGCAPI-Records Items page for the sub-portal collection</li> <li>This returns a GeoJSON feature collection JSON document</li> <li>Since we haven't put a filter on the sub-portal, all 7 metadata records in the GN4 catalog will be shown</li> </ul> </li> <li>Go to http://localhost:7979/ogcapi-records/collections/subportal/items/da165110-88fd-11da-a88f-000d939bc5d8?f=json<ul> <li>This is the OGCAPI-Records Items page for single record in the sub-portal collection</li> <li>This is the JSON representation of the ISO19193 record (in the format specified by the OGCAPI-Records specification and in GeoJSON format)</li> <li>It also contains the underlying record, in XML, in the the <code>metadataRecordText</code> property</li> </ul> </li> </ol> <p>Here are some queries you can run (see the queryables):</p> <ul> <li>Find <code>contacts</code> that contain \"jody\" http://localhost:7979/ogcapi-records/collections/subportal/items?contacts=jody&amp;f=json<ul> <li>or jeroen</li> <li>or by area code 250</li> <li>or by city victoria</li> </ul> </li> <li>Find by <code>id</code> http://localhost:7979/ogcapi-records/collections/subportal/items?id=9bac358b-11ec-4293-aeef-5a077b778412&amp;f=json</li> <li>Find by <code>organization</code> http://localhost:7979/ogcapi-records/collections/subportal/items?organization=geocat&amp;f=json</li> <li>Find by <code>keyword</code> http://localhost:7979/ogcapi-records/collections/subportal/items?keywords=africa&amp;f=json</li> <li>Find records created in 2008 http://localhost:7979/ogcapi-records/collections/subportal/items?created=2007-01-01/2007-12-31&amp;f=json</li> </ul> <p>NOTE: See the OGCAPI-Records Specification for more info on querying.</p> <p>NOTE:  You can change the above URLs to have 'f=html`.  However, the current HTML page is trivial - just showing the JSON result.</p>"},{"location":"OGCAPI-Records/develop/","title":"Technical Overview","text":"<p>Here is a technical overview so developers can easily contribute!</p>"},{"location":"OGCAPI-Records/develop/#history","title":"History","text":"<p>The GeoNetwork Microservices Project had an OGCAPI-Records implementation.  This was used as a basis for the GN5 implementation.</p>"},{"location":"OGCAPI-Records/develop/#development-of-gn5s-ogcapi-records","title":"Development of GN5's OGCAPI-Records","text":"<p>The main development technique was to use the OGC provided OpenAPI .yaml definitions to autogenerate all the Controller and Model classes using the openapi-generator.</p> <p>Unfortunately, the code generated was difficult to use.  In order to fix this, the .yaml definitions were modified to produce better generated code.</p> <ol> <li>Some of the deeply nested inline schemas did not generate java classes - these were moved into their own files.  See the extracted directory (<code>/src/modules/ogcapi-records/ogcapi-records-openapi-autogen/src/ogc-openapi-schema/openapi/schemas/extracted</code>).</li> <li>Sometimes classes were generated with a trailing <code>1</code> - these definitions need to be, also, moved to their own file.</li> <li>The only interface should be the GeoJSON geometry interface.  Any other interfaces should be investigated - they are typically caused by <code>oneOf</code> OpenAPI definitions.  These modifications will make minor changes between the specification and GN5 implementation.  However, in many cases, these are mostly invisible.     For example, in the specification, <code>ID</code>s can either be a string or integer.  The code generator produces an interface for this.  The OpenAPI .yaml was modified so it is only a string.  However, the parser (Jackson <code>ObjectMapper</code>) allows for input as an integer OR string.  However, the output is always a string.     See the Jackson <code>ObjectMapper</code> configuration in <code>WebConfig.java</code>.</li> <li>The GeoJSON geometry definition was heavily modified for better parsing and output.  However, the resulting .yaml definition is equivalent. </li> <li>A few properties are defined as a list OR a single-value.  These were replaced with list-only output.  This produces valid output.</li> <li>The property <code>itemType</code> can be either a list OR a single-value.  However, output as a list caused issues with some clients.  It was replaced with a single-value only.  This could cause some issues in the future (in the unlikely situation where there needs to be multiple <code>itemType</code>s).</li> <li>BBOX and Time have some minor changes.</li> </ol> <p>Please see the <code>README.md</code> files in the code base, and the comments in the .yaml files.</p>"},{"location":"OGCAPI-Records/develop/#modules","title":"Modules","text":"<p>The OGCAPI-Records modules are in two sections - <code>modules</code> (the codegen and very simple controllers) and <code>shared</code> (actual implementation).</p> Example of how the modules are used <p>This diagram shows:</p> <ol> <li>At the top - OpenAPI .yaml is used to generate the <code>Model</code> and spring-boot java <code>Controller</code> definitions.  See <code>modules/ogcapi-records/gn-ogcapi-records-openapi-autogen</code>.</li> <li>There is a very simple controller implementation that hands off processing.  See <code>modules/ogcapi-records/gn-ogcapi-records-openapi-implementation</code>.</li> <li>There is an actual implementation (interacts with Elastic and PostgreSQL) and does the actual work.  The vast majority of the code is here. See <code>shares/ogcapi-records</code>.</li> </ol>"},{"location":"OGCAPI-Records/develop/#appgeonetwork","title":"app/geonetwork","text":"<p>This is the main GN5 application.  There isn't any OGCAPI-Records specific code here (however, see <code>application.yml</code>).</p>"},{"location":"OGCAPI-Records/develop/#modulesogcapi-records","title":"modules/ogcapi-records","text":"<p>There are two sub-modules here:</p> gn-ogcapi-records-openapi-autogen This is the modified OGC's OpenAPI .yaml definitions used to autogenerate code.  There are also several test cases from the specification. gn-ogcapi-records-implementation This is very simple controllers and spring boot HTTP support."},{"location":"OGCAPI-Records/develop/#sharesogcapi-records","title":"shares/ogcapi-records","text":"<p>This module is where most of the code is located. It interacts with Elastic/PostgreSQL and does conversions between GeoNetwork objects and OGCAPI-Records objects. </p>"},{"location":"OGCAPI-Records/develop/#elastic-json-index-record","title":"Elastic JSON Index Record","text":"<p>The OGCAPI-Records mostly interacts with Elastic (and not with GeoNetwork or the underlying XML Metadata records).  This is because the Elastic JSON Index Record has already summarized all different types of Metadata records that GeoNetwork supports.  Therefore, most of the code is:</p> <ol> <li>Translating incoming OGCAPI-Records requests into Elastic Queries</li> <li>Translating the Elastic JSON Index Record into the corresponding OGCAPI-Records response objects</li> <li>Adding links to the OGCAPI-Records response documents</li> </ol> <p>NOTE: there is some interaction with the GeoNetwork PostgreSQL database - mostly for the <code>source</code> table (for portal/sub-portal definitions) and <code>user</code>/<code>usergroup</code> for security.</p>"},{"location":"OGCAPI-Records/develop/#conversion-from-elastic-json-index-record-to-ogcapi-records","title":"Conversion from Elastic JSON Index Record to OGCAPI-Records","text":"<ol> <li>The <code>indexing</code> modules already support converting the Elastic JSON Index Record into the <code>IndexRecord</code> java object</li> <li>The conversion from the <code>IndexRecord</code> java object into the autogenerated OGCAPI-Records java objects is mostly done in the <code>indexConvert</code> package (see test cases).</li> </ol>"},{"location":"OGCAPI-Records/develop/#elastic-query-generation","title":"Elastic Query Generation","text":"<p>There are several classes that are used for Elastic Query Generation.  We are using the new Elastic Java API:</p> <ol> <li><code>OgcApiQuery.java</code> - this is a direct representation of the <code>/collections/&lt;collectionID&gt;</code> query.  Its is built, from a request, by <code>QueryBuilder.java</code>.</li> <li><code>RecordsEsQueryBuilder.java</code> - This was taken from the Geonetwork-microservices project and updated for the new Elastic Java API.  It handles the basic OGC-defined Query.</li> <li><code>QueryToElastic.java</code> - This extends the <code>RecordsEsQueryBuilder</code> query with Queryables.</li> <li><code>QueryablesExtractor.java</code> - This converts simple text searches into queryable searches (see Extra Feature)</li> <li><code>ElasticWithUserPermission.java</code> - This adds a GN security filter to the query so users only see records they have permissions for.  See security.</li> <li><code>SimpleElastic.java</code> - simple wrapper around the Elastic search client for easy-of-use.</li> </ol>"},{"location":"OGCAPI-Records/develop/#queryables","title":"Queryables","text":"<p>GN5's OGCAPI-Records implementation supports queryables.</p>"},{"location":"OGCAPI-Records/develop/#queryables-configuration","title":"Queryables Configuration","text":"<p>GN5's OGCAPI-Records implementation supports configuring queryables.  You can add queryables for anything in the Elastic Index!</p> <p>See <code>queryables.json</code> in the code base for examples and documentation.</p>"},{"location":"OGCAPI-Records/develop/#security","title":"Security","text":"<p>The OGCAPI-Records implementation is read-only, so the biggest security issue is to ensure that user's cannot access records they don't have access to.</p> <p>GN5 adds an Elastic <code>BoolQuery.must()</code> query to generated queries that checks to see if the record is setup so that the current user is in a group that has permissions for that record.  See <code>ElasticWithUserPermissions.java</code> and  the GN4 permissions documentation.</p>"},{"location":"OGCAPI-Records/develop/#testing","title":"Testing","text":"<p>There are some simple test cases for functionality (i.e. parsing, conversions). Also, this has been tested against several OGCAPI-Records clients (including the STAC Browser).</p>"},{"location":"OGCAPI-Records/develop/#other-resources","title":"Other resources","text":"<ol> <li>The OGCAPI-Records Specification</li> <li>The OGC's OpenAPI .yaml definitions</li> <li>The GN5 GitHub Code Base</li> <li>See the README.md files in the code base</li> </ol>"},{"location":"OGCAPI-Records/features/","title":"Features","text":""},{"location":"OGCAPI-Records/features/#ogcapi-records-features","title":"OGCAPI-Records Features","text":"<p>The GeoNetwork 5 OGCAPI-Records module has several features that aren't standard in OGCAPI-Records Specification.</p>"},{"location":"OGCAPI-Records/features/#extra-features","title":"Extra Features","text":"<ol> <li>If you connect the main portal to a service metadata record, then the landing page will have a <code>catalogInfo</code> property with a <code>catalog.yaml</code> (as defined by OGCAPI-Records) object describing the catalog.</li> <li>When a catalog (collection) is described (for example, the <code>landing page</code>, <code>/collections</code>, or <code>/collections/&lt;collectionID&gt;</code> pages) and the collection is attached to a service metadata record, then there will be a <code>geoNetworkElasticIndexRecord</code> property with the underlying Elastic Index Record for that metadata record.</li> <li>When you view a metadata record (for example, the <code>/collections/&lt;collectionID&gt;/items</code> or  <code>/collections/&lt;collectionID&gt;/items/&lt;itemID&gt;</code> pages), then;<ul> <li>There will be a <code>metadataRecordText</code> property with the text of the metadata record</li> <li>There will be a <code>geoNetworkElasticIndexRecord</code> property with the underlying Elastic Index Record for that metadata record.</li> </ul> </li> <li>When doing a text search (\"<code>q</code>\"), you can add <code>&lt;queryable Property Name&gt;:&lt;search value&gt;</code> and it will convert that into a queryables search<ul> <li>For example, <code>http://localhost:7979/ogcapi-records/collections/subportal/items?q=portal%20contacts:geocat</code> is equivalent to  <code>http://localhost:7979/ogcapi-records/collections/subportal/items?q=portal&amp;contacts=geocat</code></li> <li>This was done because most OGCAPI-Records clients do not support queryables. </li> </ul> </li> <li>Security.  The logged in user can only see certain records (see <code>ElasticWithUserPermissions.java</code>).</li> </ol>"},{"location":"OGCAPI-Records/spec-diff/","title":"Spec diff","text":""},{"location":"OGCAPI-Records/spec-diff/#differences-with-the-specification","title":"Differences with the Specification","text":"<p>There are some minor differences with the specification - these are mostly due to difficulties in the OGCAPI-Records OpenAPI .yaml (especially with <code>oneOf</code> OpenAI definitions).</p> <p>Please see the comments in the README.md and .yaml files in the code autogeneration module (<code>src/modules/ogcapi-records/ogcapi-records-openapi-autogen/src/ogc-openapi-schema</code>).</p> <ol> <li>The specification allows <code>ID</code>s to be either integers or strings.  We support incoming strings or integers, but they are always outputted as strings.</li> <li><code>bbox.yaml</code> slightly simplified</li> <li><code>time.yaml</code> slightly simplified by only having one time regex instead of several in a <code>oneOf</code>.</li> <li>The <code>itemtype</code> property can either be a list of a single value.  This was simplified to be only a simple string property (no list).  This was originally simplified to be a list (most compatible), however, some clients do not accepts an <code>itemType</code> list so it was changed to be a single value.</li> </ol> <p>There are other, minor changes.  Please report an issue if you see one.</p> <p>Some of the conversions from the Elastic JSON Index Record to a GeoJSON record (or <code>catalog.yaml</code> object) are simplified and will need ongoing community discussion to ensure they are the best possible outcome.</p>"}]}