geonetwork:
  tasks:
    data-ingester:
# Data analyzer configuration use the batch API to inject information in the metadata.
# * xpath should contain all element name in case the target element needs to be created.
      resources:
        - type: "dataset"
          properties:
            - name: "name"
              help: "Set the title of the dataset if not set and not starts with 'Copy of' prefix."
              context: "DatasetLayer"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_delete"
                  xpath: "mdb:identificationInfo/mri:MD_DataIdentification/mri:citation/cit:CI_Citation/cit:title/gco:CharacterString"
                  condition: "starts-with(./mdb:identificationInfo/*/mri:citation/*/cit:title/gco:CharacterString, 'Copy of')"
                - schema: "iso19115-3.2018"
                  operation: "gn_create"
                  xpath: "mdb:identificationInfo/mri:MD_DataIdentification/mri:citation/cit:CI_Citation/cit:title/gco:CharacterString"
                  condition: "starts-with(./mdb:identificationInfo/*/mri:citation/*/cit:title/gco:CharacterString, 'Copy of') or count(./mdb:identificationInfo/*/mri:citation/*/cit:title) = 0"
                  value: "{{title}}"


            - name: "spatialRepresentationType"
              help: "Set the spatial representation type of the dataset. If not set, it will be set to 'vector'"
              context: "DatasetLayer"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_delete"
                  xpath: "mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialRepresentationType"
                - schema: "iso19115-3.2018"
                  operation: "gn_create"
                  xpath: "mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialRepresentationType"
                  value: >
                    <mri:spatialRepresentationType xmlns:mri="http://standards.iso.org/iso/19115/-3/mri/1.0"
                                     xmlns:mcc="http://standards.iso.org/iso/19115/-3/mcc/1.0">
                      <mcc:MD_SpatialRepresentationTypeCode
                            codeList="http://standards.iso.org/iso/19115/resources/Codelists/cat/codelists.xml#MD_SpatialRepresentationTypeCode"
                            codeListValue="{{datasetType:-vector}}"/>
                    </mri:spatialRepresentationType>

            - name: "latLonBoundingBox"
              help: "Replace existing geographic bounding box"
              context: "DatasetLayer"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_delete"
                  xpath: "mdb:identificationInfo/mri:MD_DataIdentification/mri:extent[@gco:nilReason='computedFromDatasource']"
                - schema: "iso19115-3.2018"
                  operation: "gn_create"
                  xpath: "mdb:identificationInfo/mri:MD_DataIdentification/mri:extent "
                  value: >
                    <mri:extent xmlns:mri="http://standards.iso.org/iso/19115/-3/mri/1.0"
                                         xmlns:gex="http://standards.iso.org/iso/19115/-3/gex/1.0"
                                         xmlns:gco="http://standards.iso.org/iso/19115/-3/gco/1.0"
                                         gco:nilReason="computedFromDatasource">
                       <gex:EX_Extent>
                         <gex:geographicElement>
                           <gex:EX_GeographicBoundingBox>
                             <gex:westBoundLongitude>
                               <gco:Decimal>{{west:--180}}</gco:Decimal>
                             </gex:westBoundLongitude>
                             <gex:eastBoundLongitude>
                               <gco:Decimal>{{east:-180}}</gco:Decimal>
                             </gex:eastBoundLongitude>
                             <gex:southBoundLatitude>
                               <gco:Decimal>{{south:--90}}</gco:Decimal>
                             </gex:southBoundLatitude>
                             <gex:northBoundLatitude>
                               <gco:Decimal>{{north:-90}}</gco:Decimal>
                             </gex:northBoundLatitude>
                           </gex:EX_GeographicBoundingBox>
                         </gex:geographicElement>
                       </gex:EX_Extent>
                    </mri:extent>


            - name: "vectorSpatialRepresentation"
              help: "For each layers, set the feature count and geometry type if geometry column found (and the dataset is not a grid)."
              context: "DatasetLayer"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_delete"
                  xpath: "mdb:spatialRepresentationInfo[@gco:nilReason = 'computedFromDatasource']"
                  condition: "count(./mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialRepresentationType[*/@codeListValue = 'grid']) = 0"
                - schema: "iso19115-3.2018"
                  operation: "gn_create"
                  xpath: "mdb:spatialRepresentationInfo"
                  condition: "count(./mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialRepresentationType[*/@codeListValue = 'grid']) = 0"
                  value: >
                    <mdb:spatialRepresentationInfo xmlns:mdb="http://standards.iso.org/iso/19115/-3/mdb/2.0"
                                                             xmlns:msr="http://standards.iso.org/iso/19115/-3/msr/2.0"
                                                             xmlns:gco="http://standards.iso.org/iso/19115/-3/gco/1.0"
                                                             gco:nilReason="computedFromDatasource">
                                <msr:MD_VectorSpatialRepresentation>
                                  <msr:geometricObjects>
                                    <msr:MD_GeometricObjects>
                                      <msr:geometricObjectType>
                                        <msr:MD_GeometricObjectTypeCode
                                          codeList="http://standards.iso.org/iso/19115/resources/Codelists/cat/codelists.xml#MD_GeometricObjectTypeCode"
                                          codeListValue="{{geometryType:-unknown}}"/>
                                      </msr:geometricObjectType>
                                      <msr:geometricObjectCount>
                                       <gco:Integer>{{featureCount}}</gco:Integer>
                                      </msr:geometricObjectCount>
                                    </msr:MD_GeometricObjects>
                                  </msr:geometricObjects>
                                </msr:MD_VectorSpatialRepresentation>
                              </mdb:spatialRepresentationInfo>


            - name: "spatialResolution"
              help: "For raster dataset, set the spatial resolution."
              context: "DatasetLayer"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_delete"
                  xpath: "mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialResolution[@gco:nilReason = 'computedFromDatasource']"
                  condition: "count(./mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialRepresentationType[*/@codeListValue = 'grid']) = 1"
                - schema: "iso19115-3.2018"
                  operation: "gn_create"
                  xpath: "mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialResolution"
                  condition: "count(./mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialRepresentationType[*/@codeListValue = 'grid']) = 1"
                  value: >
                    <mri:spatialResolution xmlns:mri="http://standards.iso.org/iso/19115/-3/mri/1.0"
                                                       xmlns:gco="http://standards.iso.org/iso/19115/-3/gco/1.0"
                                                       gco:nilReason="computedFromDatasource">
                       <mri:MD_Resolution>
                          <mri:distance>
                             <gco:Distance uom="m">{{spatialResolution:-}}</gco:Distance>
                          </mri:distance>
                       </mri:MD_Resolution>
                    </mri:spatialResolution>


            - name: "rasterSpatialRepresentation"
              help: "For raster dataset, set the X and Y dimension info."
              context: "DatasetLayer"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_delete"
                  xpath: "mdb:spatialRepresentationInfo[@gco:nilReason = 'computedFromDatasource']"
                  condition: "count(./mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialRepresentationType[*/@codeListValue = 'grid']) = 1"
                - schema: "iso19115-3.2018"
                  operation: "gn_create"
                  xpath: "mdb:spatialRepresentationInfo"
                  condition: "count(./mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialRepresentationType[*/@codeListValue = 'grid']) = 1"
                  value: >
                    <mdb:spatialRepresentationInfo xmlns:mdb="http://standards.iso.org/iso/19115/-3/mdb/2.0"
                                                                                                                  xmlns:msr="http://standards.iso.org/iso/19115/-3/msr/2.0"
                                                                                                                  xmlns:gco="http://standards.iso.org/iso/19115/-3/gco/1.0"
                                                                                                                  gco:nilReason="computedFromDatasource">
                      <msr:MD_GridSpatialRepresentation>
                        <msr:numberOfDimensions>
                          <gco:Integer>2</gco:Integer>
                        </msr:numberOfDimensions>
                        <msr:axisDimensionProperties>
                          <msr:MD_Dimension>
                            <msr:dimensionName>
                            <msr:MD_DimensionNameTypeCode codeList="http://standards.iso.org/iso/19115/resources/Codelists/cat/codelists.xml#MD_DimensionNameTypeCode"
                            codeListValue="column"/>
                            </msr:dimensionName>
                            <msr:dimensionSize>
                            <gco:Integer>{{dimensionSizeX:-}}</gco:Integer>
                            </msr:dimensionSize>
                          </msr:MD_Dimension>
                        </msr:axisDimensionProperties>
                        <msr:axisDimensionProperties>
                          <msr:MD_Dimension>
                            <msr:dimensionName>
                            <msr:MD_DimensionNameTypeCode codeList="http://standards.iso.org/iso/19115/resources/Codelists/cat/codelists.xml#MD_DimensionNameTypeCode"
                            codeListValue="row"/>
                            </msr:dimensionName>
                            <msr:dimensionSize>
                            <gco:Integer>{{dimensionSizeY:-}}</gco:Integer>
                            </msr:dimensionSize>
                          </msr:MD_Dimension>
                        </msr:axisDimensionProperties>
                        <msr:cellGeometry>
                          <msr:MD_CellGeometryCode codeList="http://standards.iso.org/iso/19115/resources/Codelists/cat/codelists.xml#MD_CellGeometryCode"
                        codeListValue="area"/>
                        </msr:cellGeometry>
                        <msr:transformationParameterAvailability>
                          <gco:Boolean>true</gco:Boolean>
                        </msr:transformationParameterAvailability>
                      </msr:MD_GridSpatialRepresentation>
                    </mdb:spatialRepresentationInfo>


            - name: "distributionFormat"
              help: "Set the distribution format of the dataset based on the data analyzer driver information if not already defined."
              context: "DatasetLayer"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_create"
                  xpath: "mdb:distributionInfo/mrd:MD_Distribution"
                  condition: "count(./mdb:distributionInfo/*/mrd:distributionFormat[*/mrd:formatSpecificationCitation/*/cit:title/*/text() ='{{formatDescription}}']) = 0"
                  value: >
                    <mrd:distributionFormat xmlns:mdb="http://standards.iso.org/iso/19115/-3/mdb/2.0"
                                                      xmlns:msr="http://standards.iso.org/iso/19115/-3/msr/2.0"
                                                      xmlns:cit="http://standards.iso.org/iso/19115/-3/cit/2.0"
                                                      xmlns:mrd="http://standards.iso.org/iso/19115/-3/mrd/1.0"
                                                      xmlns:gco="http://standards.iso.org/iso/19115/-3/gco/1.0"
                                                      gco:nilReason="computedFromDatasource">
                                <mrd:MD_Format>
                                  <mrd:formatSpecificationCitation>
                                    <cit:CI_Citation>
                                      <cit:title>
                                        <gco:CharacterString>{{formatDescription:-}}</gco:CharacterString>
                                      </cit:title>
                                      <cit:alternateTitle>
                                        <gco:CharacterString>{{format:-}}</gco:CharacterString>
                                      </cit:alternateTitle>
                                    </cit:CI_Citation>
                                  </mrd:formatSpecificationCitation>
                                </mrd:MD_Format>
                              </mrd:distributionFormat>

            - name: "distribution"
              help: "Set an online resource pointing to the dataset if not already defined."
              context: "DatasetLayer"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_create"
                  xpath: "mdb:distributionInfo/mrd:MD_Distribution/mrd:transferOptions/mrd:MD_DigitalTransferOptions"
                  condition: "count(./mdb:distributionInfo//mrd:onLine[*/cit:linkage/gco:CharacterString = '{{datasetUrl}}']) = 0"
                  value: >
                    <mrd:onLine xmlns:mdb="http://standards.iso.org/iso/19115/-3/mdb/2.0"
                                          xmlns:msr="http://standards.iso.org/iso/19115/-3/msr/2.0"
                                          xmlns:cit="http://standards.iso.org/iso/19115/-3/cit/2.0"
                                          xmlns:mrd="http://standards.iso.org/iso/19115/-3/mrd/1.0"
                                          xmlns:gco="http://standards.iso.org/iso/19115/-3/gco/1.0">
                      <cit:CI_OnlineResource>
                        <cit:linkage>
                         <gco:CharacterString>{{datasetUrl}}</gco:CharacterString>
                        </cit:linkage>
                        <cit:protocol>
                         <gco:CharacterString>WWW:DOWNLOAD:{{format:-}}</gco:CharacterString>
                        </cit:protocol>
                      </cit:CI_OnlineResource>
                    </mrd:onLine>

            - name: "featureCatalogue"
              help: "Add feature catalogue information to the dataset if not exists."
              context: "DatasetLayer"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_create"
                  xpath: "mdb:contentInfo"
                  condition: "count(mdb:contentInfo/*[@uuid='fc/{{featureTypeName}}']) = 0 and count(./mdb:identificationInfo/mri:MD_DataIdentification/mri:spatialRepresentationType[*/@codeListValue = 'grid']) = 0"
                  value: >
                    <mrc:MD_FeatureCatalogue xmlns:mdb="http://standards.iso.org/iso/19115/-3/mdb/2.0"
                                                                                            xmlns:mrc="http://standards.iso.org/iso/19115/-3/mrc/2.0"
                                                                                            xmlns:cat="http://standards.iso.org/iso/19115/-3/cat/1.0"
                                                                                            xmlns:gfc="http://standards.iso.org/iso/19110/gfc/1.1"
                                                                                            xmlns:gco="http://standards.iso.org/iso/19115/-3/gco/1.0"
                                                                                            uuid="fc/{{featureTypeName}}">
                      <mrc:featureCatalogue>
                        <gfc:FC_FeatureCatalogue>
                          <cat:name>
                            <gco:CharacterString>{{featureTypeName}}</gco:CharacterString>
                          </cat:name>
                          <cat:scope gco:nilReason="missing">
                            <gco:CharacterString/>
                          </cat:scope>
                          <cat:versionNumber gco:nilReason="missing">
                            <gco:CharacterString/>
                          </cat:versionNumber>
                        </gfc:FC_FeatureCatalogue>
                      </mrc:featureCatalogue>
                    </mrc:MD_FeatureCatalogue>

            - name: "featureType"
              context: "DatasetLayer"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_add"
                  xpath: "/mdb:contentInfo/*[@uuid = 'fc/{{featureTypeName}}']/mrc:featureCatalogue/*"
                  condition: "count(mdb:contentInfo/*[@uuid = 'fc/{{featureTypeName}}']/mrc:featureCatalogue/*/gfc:featureType[*/gfc:typeName = '{{featureTypeName}}']) = 0"
                  value: >
                    <gfc:featureType xmlns:mrc="http://standards.iso.org/iso/19115/-3/mrc/2.0"
                      xmlns:cat="http://standards.iso.org/iso/19115/-3/cat/1.0"
                      xmlns:gfc="http://standards.iso.org/iso/19110/gfc/1.1"
                      xmlns:gco="http://standards.iso.org/iso/19115/-3/gco/1.0">
                        <gfc:FC_FeatureType>
                          <gfc:typeName>{{featureTypeName}}</gfc:typeName>
                          <gfc:isAbstract>
                          <gco:Boolean>false</gco:Boolean>
                          </gfc:isAbstract>
                        </gfc:FC_FeatureType>
                      </gfc:featureType>

            - name: "featureTypeColumns"
              context: "DatasetColumns"
              operations:
                - schema: "iso19115-3.2018"
                  operation: "gn_add"
                  xpath: "/mdb:contentInfo/*[@uuid = 'fc/{{featureTypeName}}']/mrc:featureCatalogue/*/gfc:featureType/*[gfc:typeName = '{{featureTypeName}}']"
                  condition: "count(mdb:contentInfo/*[@uuid = 'fc/{{featureTypeName}}']/mrc:featureCatalogue/*/gfc:featureType/*[gfc:typeName = '{{featureTypeName}}']/gfc:carrierOfCharacteristics[*/gfc:memberName = '{{fieldName}}']) = 0"
                  value: >
                    <gfc:carrierOfCharacteristics xmlns:mrc="http://standards.iso.org/iso/19115/-3/mrc/2.0"
                                                                             xmlns:cat="http://standards.iso.org/iso/19115/-3/cat/1.0"
                                                                             xmlns:gfc="http://standards.iso.org/iso/19110/gfc/1.1"
                                                                             xmlns:gco="http://standards.iso.org/iso/19115/-3/gco/1.0">
                      <gfc:FC_FeatureAttribute>
                        <gfc:memberName>{{fieldName:-}}</gfc:memberName>
                        <gfc:definition>
                          <gco:CharacterString>{{fieldDescription:-}}</gco:CharacterString>
                        </gfc:definition>
                        <gfc:valueType>
                          <gco:TypeName>
                            <gco:aName>
                              <gco:CharacterString>{{fieldType:-}}</gco:CharacterString>
                            </gco:aName>
                          </gco:TypeName>
                        </gfc:valueType>
                      </gfc:FC_FeatureAttribute>
                    </gfc:carrierOfCharacteristics>

