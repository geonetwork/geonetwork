<div class="w-full">
  <p-button
    [disabled]="!isRecordCreated()"
    label="Cancel"
    icon="fa fa-xmark"
    severity="danger"
    (onClick)="onNewRecordCancel()"
    class="float-end m-4" />

  @if (errorMessage()) {
    <div class="float-end m-4">
      <p-message severity="error" closable>{{ errorMessage() }}</p-message>
    </div>
  }
</div>

<p-stepper [(value)]="activeStep" class="p-10 w-full">
  <p-step-item [value]="1">
    <p-step>Choose resource type</p-step>
    <p-step-panel>
      <ng-template
        pTemplate="content"
        let-activateCallback="activateCallback"
        let-index="index">
        <div class="grid md:grid-cols-2 gap-x-8 mb-10">
          <div class="w-full">
            <g-templates-selector
              [(template)]="template"></g-templates-selector>
          </div>
          <div class="basis-1/4">
            Choose a type of resource to describe (eg. geospatial, tabular,
            statistical, maps) and select a template to start with.
          </div>
        </div>

        <div class="flex mt-2 gap-2">
          <p-button
            label="Add data"
            icon="fas fa-upload"
            iconPos="right"
            data-cy="gn-new-record-button-step-data"
            [disabled]="!isTemplateSelected()"
            (onClick)="activateCallback(2)" />
          <p-button
            label="Edit record"
            icon="fas fa-plus"
            iconPos="right"
            data-cy="gn-new-record-button-edit"
            [disabled]="!isTemplateSelected()"
            (onClick)="createRecord(true)" />
        </div>
      </ng-template>
    </p-step-panel>
  </p-step-item>
  <p-step-item [value]="2">
    <p-step [disabled]="!isTemplateSelected()"
      >Upload or connect your data</p-step
    >
    <p-step-panel>
      <ng-template
        pTemplate="content"
        let-activateCallback="activateCallback"
        let-index="index">
        <div class="grid grid-cols-2 gap-x-8 mb-10">
          <div class="basis-1/2">
            <p-inputGroup>
              <p-inputGroupAddon>
                <i class="fa fa-link"></i>
                URL
              </p-inputGroupAddon>
              <input
                pInputText
                id="datasource"
                aria-describedby="datasource-help"
                [disabled]="isDatasourceFileSelected()"
                (change)="onDatasourceChange()"
                [(ngModel)]="datasource" />
              <button
                type="button"
                pButton
                label="Find datasets"
                [disabled]="isFetchingLayers() || isDatasourceFileSelected()"
                (click)="getLayerList()"></button>
            </p-inputGroup>

            <div class="font-bold w-full text-2xl text-center">or</div>

            <div class="mb-10">
              <p-fileupload
                #fileUpload
                styleClass="w-full"
                [customUpload]="true"
                (onSelect)="onAttachmentSelected($event)"
                (uploadHandler)="onUploadHandler($event)"
                (onRemove)="onRemove($event)"
                (onClear)="onClear($event)"
                name="attachement_upload"
                chooseIcon="fa fa-folder"
                chooseLabel="Select your file"
                uploadLabel="Upload"
                accept="text/*,image/*,application/*"
                multiple="true"
                [maxFileSize]="100 * 1000000">
                <ng-template #empty>
                  <div>
                    Drag and drop files to here to upload.

                    <p class="font-medium mt-10">
                      Maximum file size is <span class="font-bold">100Mo</span>.
                    </p>
                  </div>
                </ng-template>
              </p-fileupload>
            </div>

            @if (isFetchingLayers()) {
              <div>
                <p-progressBar
                  mode="indeterminate"
                  [style]="{ height: '6px' }" />
              </div>
            }

            @if (errorFetchingLayers()) {
              <p class="error-message">
                An error occurred retrieving dataset information. Please try
                later.
              </p>
              <small class="error-message"
                >Error is: {{ errorFetchingLayers() }}</small
              >
            }

            @if (metadataFiles().length > 0) {
              <div class="mb-10">
                <div class="w-full">
                  Select the metadata dataset file to process
                </div>
                <p-listbox
                  [options]="metadataFiles()"
                  (onChange)="onMetadataFileSelectedChange($event)"
                  optionLabel="filename"
                  optionValue="filename" />
              </div>
            }

            @if (layers().length > 0) {
              <div title=" Select the dataset name to analyse">
                <label for="layername" class="w-full"
                  >{{ layers().length }} dataset(s) found</label
                >
                <p-select
                  id="layername"
                  styleClass="w-full"
                  disabled="{{ layers().length === 0 }}"
                  [options]="layers()"
                  [(ngModel)]="layername"
                  (onChange)="onLayerChange()"
                  placeholder="Select a dataset" />
              </div>
            }
          </div>
          <div class="basis-1/2">
            <span
              >Point to the datasource URL or upload a new file and select the
              dataset to register.</span
            >

            <h2 class="font-medium mt-10">Supported data formats:</h2>
            @for (format of mainSupportedFormats(); track format) {
              <p-chip
                [title]="format.description + ' - ' + format.dataType"
                [label]="format.name"
                class="mr-2"></p-chip>
            }
          </div>
        </div>

        <div class="flex mt-2 gap-2">
          <p-button
            label="Back"
            icon="fas fa-arrow-left"
            severity="secondary"
            (onClick)="activateCallback(1)" />
          <p-button
            [disabled]="!isDatasourceAndTemplateSelected()"
            label="Analyze dataset"
            icon="fas fa-arrow-right"
            iconPos="right"
            (onClick)="activateCallback(3)" />
        </div>
      </ng-template>
    </p-step-panel>
  </p-step-item>
  <p-step-item [value]="3">
    <p-step
      [disabled]="!(isTemplateSelected() && isDatasourceAndTemplateSelected())"
      >Data analysis summary</p-step
    >
    <p-step-panel>
      <ng-template
        pTemplate="content"
        let-activateCallback="activateCallback"
        let-index="index">
        <div>
          @if (isExecutingAnalysis()) {
            <p-progressBar mode="indeterminate" [style]="{ height: '6px' }" />
          }
          @if (errorExecutingAnalysis()) {
            <p class="error-message">
              An error analysing the dataset information. Please try later.
            </p>
            <small class="error-message">{{ errorExecutingAnalysis() }}</small>
          } @else if (analysisResult()) {
            <g-data-analysis-panel
              [analysisResult]="analysisResult"></g-data-analysis-panel>
          }
        </div>
        <div class="flex mt-2 gap-2">
          <p-button
            label="Back"
            icon="fas fa-arrow-left"
            severity="secondary"
            (onClick)="activateCallback(2)" />
          <p-button
            [disabled]="!analysisResult()"
            label="Choose overview"
            icon="fas fa-arrow-right"
            iconPos="right"
            (onClick)="activateCallback(4)" />
        </div>
      </ng-template>
    </p-step-panel>
  </p-step-item>
  <p-step-item [value]="4">
    <p-step
      [disabled]="
        !(
          isTemplateSelected() &&
          isDatasourceAndTemplateSelected() &&
          analysisResult()
        )
      "
      >Choose overview</p-step
    >
    <p-step-panel>
      <ng-template
        pTemplate="content"
        let-activateCallback="activateCallback"
        let-index="index">
        @if (buildingOverview()) {
          <p-progressBar mode="indeterminate" [style]="{ height: '6px' }" />
        }

        <g-overview-selector
          class="mt-2"
          [uuid]="newRecordId()"
          [suggestion]="overviewFromData()"></g-overview-selector>

        <div class="flex mt-2 gap-2">
          <p-button
            label="Back"
            icon="fas fa-arrow-left"
            severity="secondary"
            (onClick)="activateCallback(3)" />
          <p-button
            [disabled]="!analysisResult()"
            label="Preview record"
            icon="fas fa-arrow-right"
            iconPos="right"
            (onClick)="activateCallback(5)" />
        </div>
      </ng-template>
    </p-step-panel>
  </p-step-item>
  <p-step-item [value]="5">
    <p-step
      [disabled]="
        !(
          isTemplateSelected() &&
          isDatasourceAndTemplateSelected() &&
          analysisResult()
        )
      "
      >Review and save</p-step
    >
    <p-step-panel>
      <ng-template
        pTemplate="content"
        let-activateCallback="activateCallback"
        let-index="index">
        <div>
          @if (isCreatingPreview()) {
            <p-progressBar mode="indeterminate" [style]="{ height: '6px' }" />
          } @else if (previewResult()) {
            <ace
              style="height: 50vh"
              [config]="{ wrap: true, tabSize: 2 }"
              [mode]="'xml'"
              [theme]="'github'"
              [(value)]="previewResult"
              [disabled]="true"></ace>
          }
        </div>
        <div class="flex mt-2 gap-2">
          <p-button
            label="Back"
            severity="secondary"
            icon="fas fa-arrow-left"
            (onClick)="activateCallback(3)" />
          <p-button
            label="Edit"
            icon="fas fa-pencil-alt"
            [disabled]="!previewResult()"
            (onClick)="applyAnalysisToRecord()" />
        </div>
      </ng-template>
    </p-step-panel>
  </p-step-item>
</p-stepper>
