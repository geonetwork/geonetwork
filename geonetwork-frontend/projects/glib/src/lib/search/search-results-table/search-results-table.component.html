@if (search) {
  @if (search.response(); as response) {
    <p-table
      #dt
      [lazy]="true"
      [loading]="search.isSearching()"
      [value]="response.hits.hits"
      [columns]="fields()"
      [paginator]="true"
      [rows]="search.pageSize()"
      [first]="search.from()"
      [totalRecords]="search.response().hits.total.value"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      (onPage)="pageChange($event)"
      [rowsPerPageOptions]="[10, 25, 50]"
      [selectionMode]="selectionMode()"
      [(selection)]="selectedRecords"
      [customSort]="true"
      (onSort)="sort($event)"
      [sortField]="currentSortField"
      [sortOrder]="currentSortOrder"
      metaKeySelection="true"
      exportFilename="search-results"
      [tableStyle]="{ 'min-width': '60rem' }"
      [scrollHeight]="scrollHeight()">
      <ng-template pTemplate="caption">
        <div class="flex items-center justify-content-between">
          <div class="grow">
            {{ response.hits.total.value }} records found

            @if (selectionMode() === 'multiple') {
              ({{ selectedRecords.length }} selected)
            }
          </div>

          @if (isAllowingColumnSelection()) {
            <p-multiSelect
              display="chip"
              [options]="columns"
              [(ngModel)]="selectedColumns"
              optionLabel="header"
              selectedItemsLabel="{0} columns selected"
              [style]="{ 'min-width': '200px' }"
              placeholder="Choose Columns" />
          }

          @if (isAllowingExport()) {
            <p-buttonGroup class="justify-self-end">
              @for (format of exportFormats; track $index) {
                <p-button
                  icon="fa fa-download"
                  label="Export ({{ format }})"
                  [outlined]="true"
                  size="small"
                  title="Export record in current page"
                  (onClick)="exportTable(format)" />
              }
            </p-buttonGroup>
          }
        </div>
      </ng-template>
      <ng-template pTemplate="header">
        <tr>
          @for (col of selectedColumns(); track $index) {
            @if (searchService.getSortableField(col.field) != undefined) {
              <th pSortableColumn="{{ col.field }}">
                {{ col.header }} <p-sortIcon field="{{ col.field }}" />
              </th>
            } @else {
              <th>{{ col.header }}</th>
            }
          }
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-hit let-rowIndex="rowIndex">
        <tr [pSelectableRow]="hit" [pSelectableRowIndex]="rowIndex">
          @for (col of selectedColumns(); track $index) {
            <td>
              <ng-template #column_content>
                @switch (col.field) {
                  @case ('overview[*]') {
                    <g-record-field-overview
                      [field]="hit._source | gJsonpath: col.field"
                      styleClass="max-w-14" />
                  }
                  @case ('resourceType[0]') {
                    <g-record-field-resource-type
                      [layout]="ResourceTypeLayout.ICON"
                      [field]="hit._source | gJsonpath: col.field" />
                  }
                  @default {
                    @if (col.field.startsWith('link')) {
                      <g-record-field-links
                        [field]="hit._source | gJsonpath: col.field" />
                    } @else if (col.field.startsWith('th_')) {
                      <g-record-field-keywords
                        [field]="hit._source | gJsonpath: col.field" />
                    } @else {
                      {{ hit._source | gJsonpath: col.field }}
                    }
                  }
                }
              </ng-template>

              @if (landingPageLinkOn() === col.field) {
                <a
                  class="text-blue-500 underline"
                  [attr.href]="this.landingPage() | gUrlPlaceholder: hit._id">
                  <ng-container *ngTemplateOutlet="column_content" />
                </a>
              } @else {
                <ng-container *ngTemplateOutlet="column_content" />
              }
            </td>
          }
        </tr>
      </ng-template>
    </p-table>
  }
}
